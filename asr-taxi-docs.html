<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Загрузка документов ASR TAXI</title>
  <style>
    :root {
      --bg: #050608;
      --card-bg: #070b10;
      --fg: #f5f5f5;
      --accent1: #00ff99;
      --accent2: #00b3ff;
      --muted: rgba(255,255,255,0.7);
      --border-soft: rgba(255,255,255,0.2);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
      background: radial-gradient(circle at top, #111827 0, #050608 55%);
      color: var(--fg);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
    }

    .wrapper {
      width: 100%;
      max-width: 520px;
      background: var(--card-bg);
      border-radius: 24px;
      padding: 24px 20px 28px;
      box-shadow: 0 24px 60px rgba(0,0,0,0.6);
    }

    .main-title {
      font-size: 22px;
      font-weight: 700;
      text-align: center;
      margin: 0 0 4px;
    }

    .main-subtitle {
      font-size: 14px;
      text-align: center;
      color: var(--muted);
      margin: 0 0 20px;
    }

    /* ===== Прогресс по шагам регистрации ===== */

    .steps-widget {
      margin-bottom: 20px;
    }

    .steps-header {
      display: flex;
      justify-content: center;
      margin-bottom: 8px;
    }

    .steps-label {
      font-size: 13px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid var(--border-soft);
    }

    .steps-bar {
      position: relative;
      height: 4px;
      border-radius: 999px;
      background: rgba(255,255,255,0.08);
      overflow: hidden;
    }

    .steps-bar-fill {
      position: absolute;
      inset: 0;
      width: 0;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--accent1), var(--accent2));
      transition: width 0.25s ease;
    }

    .steps-names {
      display: flex;
      justify-content: space-between;
      margin-top: 8px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: rgba(255,255,255,0.5);
    }

    .step-name {
      flex: 1;
      text-align: center;
      padding: 0 4px;
      transition: color 0.2s ease;
    }

    .step-name--active {
      color: #ffffff;
      font-weight: 600;
    }

    .step-name--done {
      color: var(--accent1);
    }

    /* ===== Шаги по документам (1 из 3) ===== */

    .doc-steps {
      display: none;
      text-align: center;
      margin-bottom: 16px;
    }

    .doc-step-label {
      font-size: 13px;
      font-weight: 600;
      color: rgba(255,255,255,0.9);
    }

    .doc-step-title {
      font-size: 14px;
      color: var(--muted);
      margin-top: 3px;
    }

    /* ===== Экраны ===== */

    .screen {
      display: none;
      text-align: center;
    }

    .screen-active {
      display: block;
    }

    .screen-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 8px;
    }

    .screen-text {
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 18px;
      line-height: 1.5;
    }

    .form-group {
      margin-bottom: 16px;
      text-align: left;
    }

    .field-label {
      font-size: 13px;
      margin-bottom: 6px;
      display: block;
    }

    .select,
    .input {
      width: 100%;
      padding: 11px 14px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: #0b1120;
      color: var(--fg);
      font-size: 15px;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }

    .select:focus,
    .input:focus {
      border-color: var(--accent1);
      box-shadow: 0 0 0 1px rgba(0,255,153,0.3);
    }

    .field-hint {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    /* ===== Камера ===== */

    .camera-container {
      position: relative;
      margin: 10px auto 8px;
      border-radius: 20px;
      overflow: hidden;
      background: #000;
      width: 100%;
      max-width: 440px;
      aspect-ratio: 3/4;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background: #000;
    }

    .frame {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }

    .frame::before {
      content: "";
      position: absolute;
      top: 10%;
      left: 8%;
      right: 8%;
      bottom: 30%;
      border: 3px solid var(--accent1);
      border-radius: 12px;
      box-shadow: 0 0 16px rgba(0,255,153,0.9);
    }

    .camera-hint {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .status-text {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
      min-height: 16px;
    }

    /* ===== Превью документа ===== */

    .preview-img-wrapper {
      margin: 10px auto 8px;
      border-radius: 18px;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      background: #000;
      max-width: 440px;
    }

    .preview-img-wrapper img {
      width: 100%;
      display: block;
    }

    .preview-hint {
      font-size: 13px;
      color: var(--muted);
      margin-top: 8px;
    }

    /* ===== Кнопки ===== */

    .buttons-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 18px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 999px;
      border: none;
      width: 100%;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.08s ease, opacity 0.08s ease, box-shadow 0.16s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent1), var(--accent2));
      color: #050608;
      box-shadow: 0 12px 30px rgba(0,0,0,0.55);
    }

    .btn-secondary {
      background: #0b1120;
      color: var(--fg);
      border: 1px solid var(--border-soft);
    }

    .btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px dashed var(--border-soft);
    }

    .btn:active {
      transform: scale(0.97);
      opacity: 0.9;
    }

    .btn-icon {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .note {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 6px;
      white-space: pre-line;
    }

    .centered {
      text-align: center;
    }

    .link-btn {
      margin-top: 18px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 18px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      color: var(--fg);
      text-decoration: none;
      font-size: 14px;
    }

    /* ===== Экран загрузки ===== */

    .loader-overlay {
      position: fixed;
      inset: 0;
      background: rgba(5,6,8,0.92);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      backdrop-filter: blur(4px);
    }

    .loader-card {
      width: 100%;
      max-width: 260px;
      background: #020617;
      border-radius: 20px;
      padding: 18px 18px 20px;
      text-align: center;
      border: 1px solid rgba(148,163,184,0.3);
      box-shadow: 0 24px 60px rgba(0,0,0,0.8);
    }

    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto 12px;
      border-radius: 999px;
      border: 3px solid rgba(148,163,184,0.3);
      border-top-color: var(--accent1);
      animation: spin 0.9s linear infinite;
    }

    .loader-title {
      font-size: 15px;
      font-weight: 600;
      margin: 0 0 4px;
    }

    .loader-text {
      font-size: 13px;
      color: var(--muted);
      margin: 0;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @media (max-width: 380px) {
      .wrapper {
        padding: 18px 14px 22px;
        border-radius: 20px;
      }
      .main-title {
        font-size: 20px;
      }
      .screen-title {
        font-size: 17px;
      }
      .btn {
        font-size: 14px;
        padding: 11px 14px;
      }
    }
  </style>
</head>
<body>
<div class="wrapper">
  <h1 class="main-title">Подключение к ASR TAXI</h1>
  <p class="main-subtitle">Загрузите документы, чтобы оператор мог быстрее подключить вас к парку.</p>

  <!-- Прогресс регистрации -->
  <div class="steps-widget">
    <div class="steps-header">
      <span class="steps-label" id="stepsLabel">Шаг 1 из 3</span>
    </div>
    <div class="steps-bar">
      <div class="steps-bar-fill" id="stepsBarFill"></div>
    </div>
    <div class="steps-names">
      <div class="step-name step-name--active" data-step="0">Авто и контакт</div>
      <div class="step-name" data-step="1">Документы</div>
      <div class="step-name" data-step="2">Готово</div>
    </div>
  </div>

  <!-- Шаги по документам -->
  <div class="doc-steps" id="docStepsBox">
    <div class="doc-step-label" id="docStepLabel">Документ 1 из 3</div>
    <div class="doc-step-title" id="docStepTitle">В/У — лицевая сторона</div>
  </div>

  <!-- ЭКРАН 1: цвет + телефон -->
  <div id="screenIntro" class="screen screen-active">
    <h2 class="screen-title">Укажите данные автомобиля</h2>
    <p class="screen-text">
      Сначала выберите цвет автомобиля и номер телефона для связи. Эти данные увидит оператор парка.
    </p>

    <div class="form-group">
      <label for="colorSelect" class="field-label">Цвет автомобиля</label>
      <select id="colorSelect" class="select">
        <option value="">Выберите цвет из списка</option>
        <option value="Жёлтый">Жёлтый</option>
        <option value="Белый">Белый</option>
        <option value="Чёрный">Чёрный</option>
        <option value="Серый">Серый</option>
        <option value="Красный">Красный</option>
        <option value="Синий">Синий</option>
        <option value="Голубой">Голубой</option>
        <option value="Коричневый">Коричневый</option>
        <option value="Зелёный">Зелёный</option>
        <option value="Розовый">Розовый</option>
        <option value="Оранжевый">Оранжевый</option>
        <option value="Фиолетовый">Фиолетовый</option>
        <option value="Бежевый">Бежевый</option>
      </select>
      <p class="field-hint" id="colorHint">
        Выберите тот же цвет, который будете указывать в анкете Яндекс.
      </p>
    </div>

    <div class="form-group">
      <label for="phoneInput" class="field-label">Номер телефона</label>
      <input
        id="phoneInput"
        class="input"
        type="tel"
        inputmode="tel"
        placeholder="+998 90 123-45-67"
      />
      <p class="field-hint" id="phoneHint">
        Укажите актуальный номер телефона для связи с оператором.
      </p>
    </div>

    <div class="buttons-row">
      <button class="btn btn-primary" id="startDocsBtn">
        <!-- Icon: Tabler arrow-right -->
        <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor"
            d="M5 12a1 1 0 0 1 1-1h9.586l-3.293-3.293a1 1 0 1 1 1.414-1.414l5 5a1.003 1.003 0 0 1 .21.326 1 1 0 0 1 0 .764 1.003 1.003 0 0 1-.21.326l-5 5a1 1 0 0 1-1.414-1.414L15.586 13H6a1 1 0 0 1-1-1Z" />
        </svg>
        <span>Продолжить к документам</span>
      </button>
    </div>
  </div>

  <!-- ЭКРАН 2: камера (съёмка документа) -->
  <div id="screenCamera" class="screen">
    <h2 class="screen-title">Сделайте фото документа</h2>
    <p class="screen-text">
      Разместите документ в рамке и сделайте чёткое фото. Можно также выбрать готовое фото из галереи.
    </p>

    <div class="camera-container">
      <video id="video" autoplay playsinline muted></video>
      <div class="frame"></div>
    </div>
    <p class="camera-hint">
      Документ должен быть полностью в кадре, без бликов и размытости.
    </p>

    <div class="buttons-row">
      <button class="btn btn-primary" id="captureBtn">
        <!-- Icon: Tabler camera -->
        <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor"
            d="M9 4a2 2 0 0 0-1.788 1.106L6.618 6H5a3 3 0 0 0-3 3v7a3 3 0 0 0 3 3h14a3 3 0 0 0 3-3v-7a3 3 0 0 0-3-3h-1.618l-.594-1.894A2 2 0 0 0 15 4H9Zm3 4a5 5 0 1 1 0 10 5 5 0 0 1 0-10Zm0 2a3 3 0 1 0 .001 6.001A3 3 0 0 0 12 10Z" />
        </svg>
        <span>Сделать фото</span>
      </button>

      <button class="btn btn-secondary" id="galleryBtn">
        <!-- Icon: Tabler photo -->
        <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor"
            d="M5 4h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2Zm0 2v12h14V6H5Zm3 2a2 2 0 1 1 0 4 2 2 0 0 1 0-4Zm-1 8 2.5-3 1.5 2 2.5-3 3.5 4H7Z" />
        </svg>
        <span>Выбрать из галереи</span>
      </button>

      <button class="btn btn-ghost" id="backToIntroBtn">
        <span>Вернуться назад</span>
      </button>
    </div>

    <p class="status-text" id="cameraStatus"></p>
  </div>

  <!-- ЭКРАН 3: подтверждение фото -->
  <div id="screenPreview" class="screen">
    <h2 class="screen-title">Проверьте фото документа</h2>
    <p class="screen-text">
      Убедитесь, что все данные читаются. Если что-то не видно — сделайте другое фото.
    </p>

    <div class="preview-img-wrapper">
      <img id="previewImg" alt="Предпросмотр документа" />
    </div>
    <p class="preview-hint">
      Документ не должен быть обрезан, размытый или с бликами.
    </p>

    <div class="buttons-row">
      <button class="btn btn-primary" id="confirmDocBtn">
        <!-- Icon: Tabler check -->
        <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor"
            d="M9.707 16.293 5.414 12l1.414-1.414 2.879 2.879 7.879-7.879L19 7l-9.293 9.293a1 1 0 0 1-1.414 0Z" />
        </svg>
        <span>Подтвердить и сохранить</span>
      </button>

      <button class="btn btn-secondary" id="retakeBtn">
        <!-- Icon: Tabler refresh -->
        <svg class="btn-icon" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="currentColor"
            d="M4 4h5v2H6.414l1.293 1.293A7 7 0 1 1 5.05 17.95l1.414-1.414A5 5 0 1 0 9 7.101V10H7V4Zm13.95 2.05A7 7 0 0 1 18 19h-5v-2h2.586l-1.293-1.293A5 5 0 0 0 17 8.515V5h2v3.586l-1.05-1.536Z" />
        </svg>
        <span>Сделать другое фото</span>
      </button>
    </div>
  </div>

  <!-- ЭКРАН 4: всё готово -->
  <div id="screenDone" class="screen">
    <h2 class="screen-title">Документы отправлены оператору</h2>
    <p class="screen-text">
      Все фотографии успешно загружены. Оператор ASR TAXI проверит документы и свяжется с вами по указанному номеру.
    </p>
    <p class="note">
      Если потребуется что-то уточнить или дослать, оператор напишет вам в Telegram.
    </p>
    <div class="centered">
      <a
        class="link-btn"
        href="https://t.me/AsrTaxiLeadBot"
        target="_blank"
        rel="noopener noreferrer"
      >
        Открыть бот ASR TAXI
      </a>
    </div>
  </div>
</div>

<!-- Экран загрузки -->
<div class="loader-overlay" id="loaderOverlay">
  <div class="loader-card">
    <div class="spinner"></div>
    <p class="loader-title">Идёт обработка…</p>
    <p class="loader-text" id="loaderText">Пожалуйста, не закрывайте страницу.</p>
  </div>
</div>

<input type="file" id="fileInput" accept="image/*" style="display:none;" />
<canvas id="canvas" style="display:none;"></canvas>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");

  const colorSelect = document.getElementById("colorSelect");
  const colorHint = document.getElementById("colorHint");
  const phoneInput = document.getElementById("phoneInput");
  const phoneHint = document.getElementById("phoneHint");

  const screenIntro = document.getElementById("screenIntro");
  const screenCamera = document.getElementById("screenCamera");
  const screenPreview = document.getElementById("screenPreview");
  const screenDone = document.getElementById("screenDone");

  const docStepsBox = document.getElementById("docStepsBox");
  const docStepLabel = document.getElementById("docStepLabel");
  const docStepTitle = document.getElementById("docStepTitle");

  const stepsLabel = document.getElementById("stepsLabel");
  const stepsBarFill = document.getElementById("stepsBarFill");
  const stepNameElems = Array.from(document.querySelectorAll(".step-name"));

  const startDocsBtn = document.getElementById("startDocsBtn");
  const captureBtn = document.getElementById("captureBtn");
  const galleryBtn = document.getElementById("galleryBtn");
  const backToIntroBtn = document.getElementById("backToIntroBtn");
  const previewImg = document.getElementById("previewImg");
  const confirmDocBtn = document.getElementById("confirmDocBtn");
  const retakeBtn = document.getElementById("retakeBtn");
  const cameraStatus = document.getElementById("cameraStatus");
  const fileInput = document.getElementById("fileInput");

  const loaderOverlay = document.getElementById("loaderOverlay");
  const loaderTextEl = document.getElementById("loaderText");

  const params = new URLSearchParams(location.search);
  const tgId = params.get("tg_id");
  const initialPhone = params.get("phone") || "";

  if (initialPhone) {
    phoneInput.value = initialPhone;
  }

  const MAIN_STEPS = ["Авто и контакт", "Документы", "Готово"];
  const DOC_STEPS = [
    { id: "vu_front", title: "В/У — лицевая сторона" },
    { id: "tech_front", title: "Техпаспорт — лицевая сторона" },
    { id: "tech_back", title: "Техпаспорт — оборотная сторона" },
  ];

  let currentMainStep = 0;
  let currentDocIndex = 0;
  let selectedColor = "";
  let storedPhone = initialPhone || "";
  let currentImageDataUrl = null;
  const collectedDocs = {};

  function setLoading(isLoading, text) {
    if (isLoading) {
      if (text) loaderTextEl.textContent = text;
      loaderOverlay.style.display = "flex";
    } else {
      loaderOverlay.style.display = "none";
    }
  }

  function setMainStep(index) {
    currentMainStep = index;
    stepsLabel.textContent = `Шаг ${index + 1} из ${MAIN_STEPS.length}`;
    const percent = (index / (MAIN_STEPS.length - 1)) * 100;
    stepsBarFill.style.width = percent + "%";

    stepNameElems.forEach((el, i) => {
      el.classList.remove("step-name--active", "step-name--done");
      if (i < index) {
        el.classList.add("step-name--done");
      } else if (i === index) {
        el.classList.add("step-name--active");
      }
    });
  }

  function showScreen(name) {
    screenIntro.classList.remove("screen-active");
    screenCamera.classList.remove("screen-active");
    screenPreview.classList.remove("screen-active");
    screenDone.classList.remove("screen-active");

    if (name === "intro") screenIntro.classList.add("screen-active");
    if (name === "camera") screenCamera.classList.add("screen-active");
    if (name === "preview") screenPreview.classList.add("screen-active");
    if (name === "done") screenDone.classList.add("screen-active");
  }

  function updateDocStepUI() {
    const step = DOC_STEPS[currentDocIndex];
    docStepsBox.style.display = "block";
    docStepLabel.textContent =
      "Документ " + (currentDocIndex + 1) + " из " + DOC_STEPS.length;
    docStepTitle.textContent = step.title;
  }

  colorSelect.addEventListener("change", () => {
    selectedColor = colorSelect.value;
    if (selectedColor) {
      colorHint.textContent =
        "Цвет выбран: " + selectedColor + ". Нажмите «Продолжить к документам».";
    } else {
      colorHint.textContent =
        "Выберите тот же цвет, который будете указывать в анкете Яндекс.";
    }
  });

  phoneInput.addEventListener("input", () => {
    const val = phoneInput.value.trim();
    storedPhone = val || initialPhone;
    if (val) {
      phoneHint.textContent =
        "Если номер изменился — оператор будет использовать именно этот номер.";
    } else {
      phoneHint.textContent =
        "Укажите актуальный номер телефона для связи с оператором.";
    }
  });

  async function startCamera() {
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      cameraStatus.textContent =
        "Камера недоступна в этом браузере. Используйте загрузку из галереи.";
      return;
    }

    setLoading(true, "Открываем камеру…");

    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false,
      });

      video.srcObject = stream;

      const playPromise = video.play();
      if (playPromise && typeof playPromise.then === "function") {
        playPromise.catch(err => {
          console.error("video.play() error:", err);
          cameraStatus.textContent = "Не удалось запустить камеру: " + err.name;
        });
      }

      video.onloadedmetadata = () => {
        setLoading(false);
        cameraStatus.textContent = "Камера запущена. Наведите документ в рамку.";
      };
    } catch (e) {
      console.error("Camera error:", e);
      setLoading(false);
      cameraStatus.textContent =
        "Не удалось получить доступ к камере. Разрешите доступ или используйте галерею.";
      alert(
        "Не удалось получить доступ к камере. Разрешите доступ в браузере или используйте галерею."
      );
    }
  }

  function stopCamera() {
    if (video && video.srcObject) {
      const tracks = video.srcObject.getTracks();
      tracks.forEach(t => t.stop());
      video.srcObject = null;
    }
  }

  function captureFromCamera() {
    if (!video || !video.srcObject) {
      cameraStatus.textContent =
        "Камера не запущена. Обновите страницу или используйте галерею.";
      return;
    }

    const vw = video.videoWidth;
    const vh = video.videoHeight;
    const width = vw || 1280;
    const height = vh || 720;

    canvas.width = width;
    canvas.height = height;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, width, height);

    const dataUrl = canvas.toDataURL("image/jpeg", 0.98);
    showPreview(dataUrl);
  }

  function showPreview(dataUrl) {
    currentImageDataUrl = dataUrl;
    previewImg.src = dataUrl;
    showScreen("preview");
  }

  // Переход с экрана 1 на этап документов
  startDocsBtn.addEventListener("click", () => {
    selectedColor = colorSelect.value;
    storedPhone = phoneInput.value.trim() || initialPhone;

    if (!selectedColor) {
      colorHint.textContent = "Пожалуйста, выберите цвет автомобиля.";
      colorSelect.focus();
      return;
    }

    if (!storedPhone) {
      phoneHint.textContent =
        "Пожалуйста, укажите номер телефона, чтобы оператор мог с вами связаться.";
      phoneInput.focus();
      return;
    }

    setMainStep(1);
    currentDocIndex = 0;
    updateDocStepUI();
    cameraStatus.textContent = "";
    showScreen("camera");
    startCamera();
  });

  // Кнопки камеры
  captureBtn.addEventListener("click", () => {
    captureFromCamera();
  });

  galleryBtn.addEventListener("click", () => {
    fileInput.click();
  });

  backToIntroBtn.addEventListener("click", () => {
    stopCamera();
    docStepsBox.style.display = "none";
    setMainStep(0);
    showScreen("intro");
  });

  fileInput.addEventListener("change", () => {
    const file = fileInput.files && fileInput.files[0];
    if (!file) return;

    if (!file.type.startsWith("image/")) {
      cameraStatus.textContent = "Пожалуйста, выберите изображение документа.";
      return;
    }

    const reader = new FileReader();
    reader.onload = e => {
      const dataUrl = e.target.result;
      showPreview(dataUrl);
    };
    reader.onerror = () => {
      cameraStatus.textContent =
        "Не удалось прочитать файл. Попробуйте ещё раз.";
    };
    reader.readAsDataURL(file);
  });

  // Превью: сделать другое фото
  retakeBtn.addEventListener("click", () => {
    currentImageDataUrl = null;
    previewImg.src = "";
    showScreen("camera");
  });

  // Превью: подтвердить документ
  confirmDocBtn.addEventListener("click", async () => {
    if (!currentImageDataUrl) {
      alert("Сначала сделайте фото документа.");
      return;
    }

    const step = DOC_STEPS[currentDocIndex];
    collectedDocs[step.id] = {
      image: currentImageDataUrl,
      title: step.title,
    };

    if (currentDocIndex < DOC_STEPS.length - 1) {
      // Переходим к следующему документу
      currentDocIndex++;
      updateDocStepUI();
      currentImageDataUrl = null;
      previewImg.src = "";
      showScreen("camera");
      cameraStatus.textContent =
        "Камера запущена. Наведите следующий документ в рамку.";
      return;
    }

    // Последний документ — отправляем всё разом
    await sendAllDocs();
  });

  async function sendAllDocs() {
    const imagesPayload = DOC_STEPS.map(stepDef => {
      const stored = collectedDocs[stepDef.id];
      if (!stored || !stored.image) return null;
      return {
        docType: stepDef.id,
        docTitle: stepDef.title,
        image: stored.image,
      };
    }).filter(Boolean);

    if (!imagesPayload.length) {
      alert("Не удалось собрать документы для отправки. Попробуйте ещё раз.");
      return;
    }

    setLoading(true, "Отправляем документы оператору…");

    try {
      const res = await fetch("/.netlify/functions/upload-doc", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          images: imagesPayload,
          tg_id: tgId || "",
          phone: storedPhone,
          carColor: selectedColor,
        }),
      });

      setLoading(false);

      if (res.ok) {
        stopCamera();
        setMainStep(2);
        docStepsBox.style.display = "none";
        showScreen("done");
      } else {
        console.error("upload-doc (batch) error status:", res.status);
        alert("Не удалось отправить документы. Попробуйте ещё раз.");
        showScreen("preview");
      }
    } catch (e) {
      setLoading(false);
      console.error("upload-doc (batch) exception:", e);
      alert("Ошибка при отправке документов. Проверьте интернет и попробуйте ещё раз.");
      showScreen("preview");
    }
  }

  // Инициализация
  setMainStep(0);
  phoneInput.dispatchEvent(new Event("input"));
</script>
</body>
</html>
