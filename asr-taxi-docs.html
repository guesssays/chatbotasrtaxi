<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ASR TAXI</title>
  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050608;
      color: #f5f5f5;
    }
    .wrapper {
      max-width: 480px;
      margin: 0 auto;
      padding: 16px;
    }
    h1 {
      font-size: 20px;
      margin-bottom: 8px;
    }
    p {
      font-size: 14px;
      opacity: 0.85;
    }
    .camera-container {
      position: relative;
      margin-top: 16px;
      border-radius: 16px;
      overflow: hidden;
      background: #000;
      aspect-ratio: 3/4;
    }
    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    /* —Ä–∞–º–∫–∞-–æ–≤–µ—Ä–ª–µ–π */
    .frame {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    .frame::before {
      content: "";
      position: absolute;
      top: 12%;
      left: 8%;
      right: 8%;
      bottom: 40%;
      border: 3px solid #00ff99;
      border-radius: 8px;
      box-shadow: 0 0 12px rgba(0,255,153,0.9);
    }
    .frame::after {
      /* –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥ —Ä–∞–º–∫–∏ */
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(
        ellipse at center,
        rgba(0, 0, 0, 0.1) 0,
        rgba(0, 0, 0, 0.65) 60%
      );
      mix-blend-mode: multiply;
    }
    .btn {
      margin-top: 16px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 16px;
      border-radius: 999px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      background: linear-gradient(135deg, #00ff99, #00b3ff);
      color: #050608;
      width: 100%;
    }
    .btn:active {
      transform: scale(0.98);
    }
    #preview {
      margin-top: 16px;
      display: none;
    }
    #preview img {
      max-width: 100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .note {
      font-size: 12px;
      opacity: 0.7;
      margin-top: 4px;
    }
  </style>
</head>
<body>
<div class="wrapper">
  <h1>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
  <p id="userInfo"></p>
  <p>–ü–æ–º–µ—Å—Ç–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤–Ω—É—Ç—Ä–∏ —Ä–∞–º–∫–∏ –∏ —Å–¥–µ–ª–∞–π—Ç–µ —Ñ–æ—Ç–æ.</p>

  <div class="camera-container">
    <video id="video" autoplay playsinline></video>
    <div class="frame"></div>
  </div>

  <button class="btn" id="captureBtn">üì∏ –°–¥–µ–ª–∞—Ç—å —Å–Ω–∏–º–æ–∫</button>
  <p id="status" class="note"></p>

  <div class="note">–§–æ—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–æ–∏—Ç—Å—è –ø–æ–¥ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç.</div>

  <div id="preview">
    <p>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞:</p>
    <img id="previewImg" alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞" />
  </div>
</div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
  const video = document.getElementById("video");
  const canvas = document.getElementById("canvas");
  const captureBtn = document.getElementById("captureBtn");
  const preview = document.getElementById("preview");
  const previewImg = document.getElementById("previewImg");
  const userInfo = document.getElementById("userInfo");
  const statusEl = document.getElementById("status");

  // –ß–∏—Ç–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL (tg_id –∏ phone)
  const params = new URLSearchParams(location.search);
  const tgId = params.get("tg_id");
  const phone = params.get("phone");

  if (phone) {
    userInfo.textContent = `–¢–µ–ª–µ—Ñ–æ–Ω: ${phone}`;
  } else {
    userInfo.textContent = "";
  }

  async function startCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: "environment" },
        audio: false,
      });
      video.srcObject = stream;
    } catch (e) {
      console.error("Camera error:", e);
      alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –±—Ä–∞—É–∑–µ—Ä–µ.");
    }
  }

  captureBtn.addEventListener("click", async () => {
    const videoTrack = (video.srcObject && video.srcObject.getVideoTracks()[0]) || null;
    const settings = videoTrack ? videoTrack.getSettings() : {};

    const width = settings.width || 720;
    const height = settings.height || 960;

    canvas.width = width;
    canvas.height = height;

    const ctx = canvas.getContext("2d");
    ctx.drawImage(video, 0, 0, width, height);

    // 1) DataURL –¥–ª—è –ø—Ä–µ–≤—å—é
    const dataUrl = canvas.toDataURL("image/jpeg", 0.9);

    // –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–≤—å—é
    previewImg.src = dataUrl;
    preview.style.display = "block";

    // 2) –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ Netlify-—Ñ—É–Ω–∫—Ü–∏—é upload-doc
    statusEl.textContent = "–û—Ç–ø—Ä–∞–≤–ª—è—é –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É...";

    try {
      const res = await fetch("/.netlify/functions/upload-doc", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          image: dataUrl,
          tg_id: tgId || "",
          phone: phone || "",
          docType: "document" // –ø–æ–∑–∂–µ –º–æ–∂–Ω–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ '–ø—Ä–∞–≤–∞', '—Ç–µ—Ö–ø–∞—Å–ø–æ—Ä—Ç' –∏ —Ç.–ø.
        }),
      });

      if (res.ok) {
        statusEl.textContent = "–î–æ–∫—É–º–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä—É ‚úÖ";
      } else {
        console.error("upload-doc error status:", res.status);
        statusEl.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.";
      }
    } catch (e) {
      console.error("upload-doc exception:", e);
      statusEl.textContent = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞.";
    }
  });

  startCamera();
</script>
</body>
</html>
