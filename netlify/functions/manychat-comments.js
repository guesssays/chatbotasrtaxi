// netlify/functions/manychat-comments.js

const JSON_HEADERS = {
  "Content-Type": "application/json",
};

exports.handler = async (event) => {
  console.log("=== manychat-comments invoked ===");
  console.log("Method:", event.httpMethod);
  console.log("Headers:", event.headers);
  console.log("Raw body:", event.body);

  try {
    // CORS / preflight
    if (event.httpMethod === "OPTIONS") {
      return {
        statusCode: 200,
        headers: JSON_HEADERS,
        body: JSON.stringify({ ok: true }),
      };
    }

    if (event.httpMethod !== "POST") {
      console.log("Wrong method, expected POST");
      return {
        statusCode: 405,
        headers: JSON_HEADERS,
        body: JSON.stringify({ error: "Method not allowed" }),
      };
    }

    // –ü–∞—Ä—Å–∏–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç ManyChat
    let body;
    try {
      body = JSON.parse(event.body || "{}");
    } catch (e) {
      console.error("Bad JSON from ManyChat:", e);
      return {
        statusCode: 400,
        headers: JSON_HEADERS,
        body: JSON.stringify({ error: "Bad JSON" }),
      };
    }

    console.log("Parsed body:", body);

    const commentText =
      body.message ||
      body.text ||
      body.comment ||
      body.user_input ||
      ""; // –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞

    const userName = body.user_name || "";
    const userId = body.user_id || body.contact_id || null;

    console.log("commentText:", commentText);
    console.log("userName:", userName);
    console.log("userId:", userId);

    if (!commentText) {
      console.log("No comment text in body");
      return {
        statusCode: 400,
        headers: JSON_HEADERS,
        body: JSON.stringify({ error: "No message provided" }),
      };
    }

    const result = await generateCommentReply(commentText, userName, userId);

    console.log("AI comment result:", result);

    return {
      statusCode: 200,
      headers: JSON_HEADERS,
      body: JSON.stringify(result),
    };
  } catch (err) {
    console.error("manychat-comments error:", err);

    // –§–æ–ª–ª–±–µ–∫, –µ—Å–ª–∏ –≤–æ–æ–±—â–µ –≤—Å—ë —É–ø–∞–ª–æ
    return {
      statusCode: 500,
      headers: JSON_HEADERS,
      body: JSON.stringify({
        reply:
          "–°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π! –û—Ç–≤–µ—Ç–∏–º –≤–∞–º —á—É—Ç—å –ø–æ–∑–∂–µ üôÇ / –†–∞—Ö–º–∞—Ç –∏–∑–æ“≥–∏–Ω–≥–∏–∑ —É—á—É–Ω! –ë–∏—Ä–∞–∑–¥–∞–Ω —Å—û–Ω–≥ –∂–∞–≤–æ–± –±–µ—Ä–∞–º–∏–∑ üôÇ",
        send_dm: 0,
        dm_text: "",
      }),
    };
  }
};

// ====== –õ–û–ì–ò–ö–ê –û–¢–í–ï–¢–ê –î–õ–Ø –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í ======

async function generateCommentReply(commentText, userName, userId) {
  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    console.error("OPENAI_API_KEY is not set");
    return {
      reply:
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π! üôÇ / –†–∞—Ö–º–∞—Ç –∏–∑–æ“≥–∏–Ω–≥–∏–∑ —É—á—É–Ω! üôÇ",
      send_dm: 0,
      dm_text: "",
    };
  }

  const systemPrompt = `
–¢—ã ‚Äî –∂–∏–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ç–∞–∫—Å–æ–ø–∞—Ä–∫–∞ ASR TAXI –≤ Instagram.
–û—Ç–≤–µ—á–∞–µ—à—å –ò–ú–ï–ù–ù–û –Ω–∞ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –ø–æ–¥ –ø–æ—Å—Ç–∞–º–∏, –Ω–µ –Ω–∞ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1) –ü–æ–Ω—è—Ç—å, —á—Ç–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: –ø—Ä–æ—Å—Ç–æ —Ä–µ–∞–∫—Ü–∏—è (—ç–º–æ–¥–∑–∏, ¬´+¬ª –∏ —Ç.–ø.) –∏–ª–∏ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç/–≤–æ–ø—Ä–æ—Å.
2) –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —è–∑—ã–∫: —Ä—É—Å—Å–∫–∏–π –∏–ª–∏ —É–∑–±–µ–∫—Å–∫–∏–π (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞).
3) –ö–æ—Ä–æ—Ç–∫–æ –æ—Ç–≤–µ—Ç–∏—Ç—å –ø–æ–¥ –ø–æ—Å—Ç–æ–º (reply) –∏, –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ, –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å —á–µ–ª–æ–≤–µ–∫–∞ –≤ Direct.
4) –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Direct (dm_text), —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ ASR TAXI.

–ü–†–ê–í–ò–õ–ê –Ø–ó–´–ö–ê:
- –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —è–≤–Ω–æ –Ω–∞ —Ä—É—Å—Å–∫–æ–º ‚Äî –æ—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏.
- –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ —É–∑–±–µ–∫—Å–∫–æ–º (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞) ‚Äî –æ—Ç–≤–µ—á–∞–π –Ω–∞ —É–∑–±–µ–∫—Å–∫–æ–º.
- –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π —Å–æ—Å—Ç–æ–∏—Ç —Ç–æ–ª—å–∫–æ –∏–∑ —ç–º–æ–¥–∑–∏, —Å—Ç–∏–∫–µ—Ä–æ–≤, —Å–∏–º–≤–æ–ª–æ–≤ —Ç–∏–ø–∞ "+", "üî•", "‚úÖ" –∏ —Ç.–ø., —Å—á–∏—Ç–∞–µ–º —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Ä–µ–∞–∫—Ü–∏–µ–π.

–û–ë–†–ê–ë–û–¢–ö–ê –†–ê–ó–ù–´–• –°–õ–£–ß–ê–ï–í:

1) –¢–û–õ–¨–ö–û –≠–ú–û–î–ó–ò / ¬´+¬ª / –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∞—è —Ä–µ–∞–∫—Ü–∏—è –±–µ–∑ —Å–º—ã—Å–ª–∞:
   - reply –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –î–í–£–Ø–ó–´–ß–ù–´–ô (—Ä—É—Å—Å–∫–∏–π + —É–∑–±–µ–∫—Å–∫–∏–π –≤ –æ–¥–Ω–æ–º —Ç–µ–∫—Å—Ç–µ).
   - –ü—Ä–∏–º–µ—Ä —Å—Ç–∏–ª—è:
     "–°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π! –ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç —É—Å–ª–æ–≤–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Äî –º–æ–∂–µ—Ç–µ –Ω–∞–ø–∏—Å–∞—Ç—å –≤ Direct üôÇ 
      –†–∞—Ö–º–∞—Ç –∏–∑–æ“≥–∏–Ω–≥–∏–∑ —É—á—É–Ω! –ê–≥–∞—Ä —É–ª–∞–Ω–∏—à —à–∞—Ä—Ç–ª–∞—Ä–∏ “õ–∏–∑–∏“õ –±—û–ª—Å–∞, Direct‚Äô–≥–∞ —ë–∑—Å–∞–Ω–≥–∏–∑ –±—û–ª–∞–¥–∏ üôÇ"
   - send_dm = 0
   - dm_text = "" (–Ω–∏—á–µ–≥–æ –≤ –¥–∏—Ä–µ–∫—Ç —Å–∞–º–∏ –Ω–µ –ø–∏—à–µ–º).

2) –ï–°–¢–¨ –í–û–ü–†–û–° –∏–ª–∏ –Ø–í–ù–´–ô –ò–ù–¢–ï–†–ï–° (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–∫–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è", "–∫–∞–∫–∞—è –∫–æ–º–∏—Å—Å–∏—è", "–ª–∏—Ü–µ–Ω–∑–∏—è —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç" –∏ —Ç.–ø.):
   - –ö—Ä–∞—Ç–∫–æ –æ—Ç–≤–µ—Ç—å –Ω–∞ —Ç–æ–º –ñ–ï —è–∑—ã–∫–µ (1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –Ω–µ –ª–µ–∫—Ü–∏—è).
   - –í –ö–û–ù–¶–ï reply –¥–æ–±–∞–≤—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –≤ Direct:
     - —Ä—É—Å—Å–∫–∏–π: "–ü–æ–¥—Ä–æ–±–Ω–æ —Å–µ–π—á–∞—Å –Ω–∞–ø–∏—à—É –≤–∞–º –≤ Direct."
     - —É–∑–±–µ–∫—Å–∫–∏–π: "–ë–∞—Ç–∞—Ñ—Å–∏–ª –∂–∞–≤–æ–±–Ω–∏ “≥–æ–∑–∏—Ä Direct‚Äô–≥–∞ —ë–∑–∏–± —é–±–æ—Ä–∞–º–∞–Ω."
   - send_dm = 1
   - dm_text ‚Äî –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Direct, –Ω–∞ —Ç–æ–º –∂–µ —è–∑—ã–∫–µ:
     ‚Ä¢ 1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.
     ‚Ä¢ –ö–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç ASR TAXI.
     ‚Ä¢ –ü–æ—è—Å–Ω–∏, —á—Ç–æ –ø–∏—à–µ—à—å –ø–æ –ø–æ–≤–æ–¥—É –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.
     ‚Ä¢ –°—Ä–∞–∑—É –∑–∞–¥–∞–π –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ –º–æ–¥–µ–ª—å –∏ –≥–æ–¥ –∞–≤—Ç–æ –∏–ª–∏ —á–µ–º –∏–º–µ–Ω–Ω–æ —Ö–æ—á–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å—Å—è ‚Äî —Ç–∞–∫—Å–∏ / –¥–æ—Å—Ç–∞–≤–∫–∞).

   –ü—Ä–∏–º–µ—Ä –ø–æ-—Ä—É—Å—Å–∫–∏:
   dm_text: "–ê—Å—Å–∞–ª–æ–º—É –∞–ª–∞–π–∫—É–º! –≠—Ç–æ ASR TAXI, –ø–∏—à—É –≤–∞–º –ø–æ –ø–æ–≤–æ–¥—É –≤–∞—à–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –ø–æ–¥ –ø–æ—Å—Ç–æ–º. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–∞–∫–∞—è —É –≤–∞—Å –º–∞—à–∏–Ω–∞ –∏ –≥–æ–¥ –≤—ã–ø—É—Å–∫–∞, —è –ø–æ–¥—Å–∫–∞–∂—É –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∏ –±–æ–Ω—É—Å–∞–º."

   –ü—Ä–∏–º–µ—Ä –ø–æ-—É–∑–±–µ–∫—Å–∫–∏:
   dm_text: "–ê—Å—Å–∞–ª–æ–º—É –∞–ª–∞–π–∫—É–º! –ë—É ASR TAXI, –ø–æ—Å—Ç –æ—Å—Ç–∏–¥–∞–≥–∏ –∏–∑–æ“≥–∏–Ω–≥–∏–∑ –±—û–π–∏—á–∞ —ë–∑–∞—è–ø–º–∞–Ω. –ú–æ—à–∏–Ω–∞ –º–æ–¥–µ–ª–∏–Ω–∏ –≤–∞ –π–∏–ª–∏–Ω–∏ —ë–∑–∏–± —é–±–æ—Ä—Å–∞–Ω–≥–∏–∑, —É–ª–∞–Ω–∏—à –≤–∞ –±–æ–Ω—É—Å–ª–∞—Ä –±—û–π–∏—á–∞ —ë—Ä–¥–∞–º –±–µ—Ä–∞–º–∞–Ω."

3) –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –ë–ï–ó –í–û–ü–†–û–°–ê, –ù–û –°–ú–´–°–õ–û–í–û–ô (–Ω–∞–ø—Ä–∏–º–µ—Ä: "—Ö–æ—á—É —Ä–∞–±–æ—Ç–∞—Ç—å", "–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ", "–Ω–∞–¥–æ –ø–æ–¥—É–º–∞—Ç—å"):
   - –û—Ç–≤–µ—Ç—å –∫–æ—Ä–æ—Ç–∫–æ –Ω–∞ —Ç–æ–º –∂–µ —è–∑—ã–∫–µ, –ø–æ–¥–¥–µ—Ä–∂–∏ –∏–Ω—Ç–µ—Ä–µ—Å.
   - –ú—è–≥–∫–æ –ø–æ–∑–æ–≤–∏ –≤ Direct (–∫–∞–∫ –≤ –ø—É–Ω–∫—Ç–µ 2).
   - send_dm = 1, dm_text –≤ —Ç–∞–∫–æ–º –∂–µ —Å—Ç–∏–ª–µ (–Ω–∞—á–∞–ª–æ –¥–∏–∞–ª–æ–≥–∞ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏).

4) –í—Å–µ–≥–¥–∞ –ø–æ–º–Ω–∏:
   - –ù–∏–∫–∞–∫–∏—Ö –¥–ª–∏–Ω–Ω—ã—Ö –ø–æ—Ä—Ç—è–Ω–æ–∫.
   - –ù–∏–∫–∞–∫–∏—Ö —É–ø–æ–º–∏–Ω–∞–Ω–∏–π, —á—Ç–æ —Ç—ã –±–æ—Ç –∏–ª–∏ –Ω–µ–π—Ä–æ—Å–µ—Ç—å.
   - –û–±—â–∞–π—Å—è, –∫–∞–∫ –∂–∏–≤–æ–π –æ–ø–µ—Ä–∞—Ç–æ—Ä —Ç–∞–∫—Å–æ–ø–∞—Ä–∫–∞.
   - –≠–º–æ–¥–∑–∏ –º–æ–∂–Ω–æ, –Ω–æ –Ω–µ–º–Ω–æ–≥–æ.

`;

  const formatPrompt = `
–û–¢–í–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –°–¢–†–û–ì–û –û–î–ù–ò–ú JSON-–û–ë–™–ï–ö–¢–û–ú –ë–ï–ó –õ–ò–®–ù–ï–ì–û –¢–ï–ö–°–¢–ê.

–§–æ—Ä–º–∞—Ç:
{
  "reply": "–∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø–æ–¥ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º",
  "send_dm": 0 –∏–ª–∏ 1,
  "dm_text": "—Ç–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Direct (–µ—Å–ª–∏ send_dm = 1, –∏–Ω–∞—á–µ –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞)"
}

–ù–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–æ—è—Å–Ω–µ–Ω–∏–π, markdown –∏ —Ç.–ø. –¢–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON.
`;

  const userPrompt = `
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–¥ –ø–æ—Å—Ç–æ–º –≤ Instagram:
"${commentText}"

–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –æ–±—Ä–∞—â–µ–Ω–∏–∏, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
"${userName || ""}"
`;

  const messages = [
    { role: "system", content: systemPrompt },
    { role: "system", content: formatPrompt },
    { role: "user", content: userPrompt },
  ];

  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model: "gpt-4o",
      messages,
      temperature: 0.5,
    }),
  });

  if (!response.ok) {
    const errText = await response.text();
    console.error("OpenAI error (comments):", response.status, errText);
    return {
      reply:
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π! –ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç —É—Å–ª–æ–≤–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ Direct üôÇ",
      send_dm: 0,
      dm_text: "",
    };
  }

  const data = await response.json();
  const raw = data.choices?.[0]?.message?.content?.trim() || "";
  console.log("Raw OpenAI answer (comments):", raw);

  let parsed;
  try {
    parsed = JSON.parse(raw);
  } catch (e) {
    console.error("Failed to parse JSON from OpenAI (comments)", e);
    // –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ JSON ‚Äî –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –∫–∞–∫ reply
    return {
      reply:
        raw ||
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π! –ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—Ç —É—Å–ª–æ–≤–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Äî –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º –≤ Direct üôÇ",
      send_dm: 0,
      dm_text: "",
    };
  }

  const reply =
    typeof parsed.reply === "string"
      ? parsed.reply.trim()
      : "–°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π! üôÇ";
  const sendDm = parsed.send_dm ? 1 : 0;
  const dmText =
    typeof parsed.dm_text === "string" ? parsed.dm_text.trim() : "";

  return {
    reply,
    send_dm: sendDm,
    dm_text: dmText,
  };
}
