// netlify/functions/manychat-comments.js

const JSON_HEADERS = {
  "Content-Type": "application/json",
};

exports.handler = async (event) => {
  console.log("=== manychat-comments invoked ===");
  console.log("Method:", event.httpMethod);
  console.log("Headers:", event.headers);
  console.log("Raw body:", event.body);

  try {
    // CORS / preflight
    if (event.httpMethod === "OPTIONS") {
      return {
        statusCode: 200,
        headers: JSON_HEADERS,
        body: JSON.stringify({ ok: true }),
      };
    }

    if (event.httpMethod !== "POST") {
      console.log("Wrong method, expected POST");
      return {
        statusCode: 405,
        headers: JSON_HEADERS,
        body: JSON.stringify({ error: "Method not allowed" }),
      };
    }

    // –ü–∞—Ä—Å–∏–º —Ç–µ–ª–æ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç ManyChat
    let body;
    try {
      body = JSON.parse(event.body || "{}");
    } catch (e) {
      console.error("Bad JSON from ManyChat:", e);
      return {
        statusCode: 400,
        headers: JSON_HEADERS,
        body: JSON.stringify({ error: "Bad JSON" }),
      };
    }

    console.log("Parsed body:", body);

    const commentText =
      body.message ||
      body.text ||
      body.comment ||
      body.user_input ||
      ""; // –ø–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞

    const userName = body.user_name || "";
    const userId = body.user_id || body.contact_id || null;

    console.log("commentText:", commentText);
    console.log("userName:", userName);
    console.log("userId:", userId);

    if (!commentText) {
      console.log("No comment text in body");
      return {
        statusCode: 400,
        headers: JSON_HEADERS,
        body: JSON.stringify({ error: "No message provided" }),
      };
    }

    const result = await generateCommentReply(commentText, userName, userId);

    console.log("AI comment result:", result);

    return {
      statusCode: 200,
      headers: JSON_HEADERS,
      body: JSON.stringify(result),
    };
  } catch (err) {
    console.error("manychat-comments error:", err);

    // –§–æ–ª–ª–±–µ–∫, –µ—Å–ª–∏ –≤–æ–æ–±—â–µ –≤—Å—ë —É–ø–∞–ª–æ
    return {
      statusCode: 500,
      headers: JSON_HEADERS,
      body: JSON.stringify({
        // –ü—É–±–ª–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–¥ –ø–æ—Å—Ç–æ–º ‚Äî –¥–≤—É—è–∑—ã—á–Ω—ã–π
        reply:
          "–°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π! –ü–æ–¥—Ä–æ–±–Ω–æ –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ Direct üôÇ / –†–∞—Ö–º–∞—Ç –∏–∑–æ“≥–∏–Ω–≥–∏–∑ —É—á—É–Ω! –ë–∞—Ç–∞—Ñ—Å–∏–ª –∂–∞–≤–æ–±–Ω–∏ Direct‚Äô–¥–∞ —ë–∑–∞–º–∏–∑ üôÇ",
        // –î–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –±–∞–∑–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –î–∏—Ä–µ–∫—Ç
        send_dm: 1,
        dm_text:
          "–ê—Å—Å–∞–ª–æ–º—É –∞–ª–∞–π–∫—É–º! –≠—Ç–æ ASR TAXI. –í–∏–¥–∏–º –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–¥ –Ω–∞—à–∏–º –ø–æ—Å—Ç–æ–º. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–∞–∫–∞—è —É –≤–∞—Å –º–∞—à–∏–Ω–∞ –∏ –≥–æ–¥ –≤—ã–ø—É—Å–∫–∞, —è –ø–æ–¥—Å–∫–∞–∂—É –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∏ –±–æ–Ω—É—Å–∞–º.",
      }),
    };
  }
};

// ====== –õ–û–ì–ò–ö–ê –û–¢–í–ï–¢–ê –î–õ–Ø –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í ======

async function generateCommentReply(commentText, userName, userId) {
  const apiKey = process.env.OPENAI_API_KEY;
  if (!apiKey) {
    console.error("OPENAI_API_KEY is not set");
    // –ë–µ–∑ –∫–ª—é—á–∞ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—ã—Ç–∞–µ–º—Å—è –≤–µ—Å—Ç–∏ –≤ –î–∏—Ä–µ–∫—Ç
    return {
      reply:
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π! –ü–æ–¥—Ä–æ–±–Ω–æ –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ Direct üôÇ / –†–∞—Ö–º–∞—Ç –∏–∑–æ“≥–∏–Ω–≥–∏–∑ —É—á—É–Ω! –ë–∞—Ç–∞—Ñ—Å–∏–ª –∂–∞–≤–æ–±–Ω–∏ Direct‚Äô–¥–∞ —ë–∑–∞–º–∏–∑ üôÇ",
      send_dm: 1,
      dm_text:
        "–ê—Å—Å–∞–ª–æ–º—É –∞–ª–∞–π–∫—É–º! –≠—Ç–æ ASR TAXI. –í–∏–¥–∏–º –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–¥ –Ω–∞—à–∏–º –ø–æ—Å—Ç–æ–º. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –∫–∞–∫–∞—è —É –≤–∞—Å –º–∞—à–∏–Ω–∞ –∏ –≥–æ–¥ –≤—ã–ø—É—Å–∫–∞, —è –ø–æ–¥—Å–∫–∞–∂—É –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∏ –±–æ–Ω—É—Å–∞–º.",
    };
  }

  const systemPrompt = `
–¢—ã ‚Äî –∂–∏–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ç–∞–∫—Å–æ–ø–∞—Ä–∫–∞ ASR TAXI –≤ Instagram.
–û—Ç–≤–µ—á–∞–µ—à—å –ò–ú–ï–ù–ù–û –Ω–∞ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò –ø–æ–¥ –ø–æ—Å—Ç–∞–º–∏, –Ω–µ –Ω–∞ –ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.

–ì–õ–ê–í–ù–ê–Ø –õ–û–ì–ò–ö–ê:
‚Äî –ú—ã –í–°–ï–ì–î–ê –ø–∏—à–µ–º —á–µ–ª–æ–≤–µ–∫—É –≤ Direct, –≤–Ω–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –æ–Ω –Ω–∞–ø–∏—Å–∞–ª –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏.
‚Äî –ü–æ–¥ –ø–æ—Å—Ç–æ–º –¥–∞—ë–º –∫–æ—Ä–æ—Ç–∫–∏–π –ø—É–±–ª–∏—á–Ω—ã–π –æ—Ç–≤–µ—Ç.
‚Äî –í Direct –Ω–∞—á–∏–Ω–∞–µ–º –¥–∏–∞–ª–æ–≥ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ ASR TAXI.

–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –Ø–ó–´–ö–ê:
‚Äî –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º ‚Äî –æ—Ç–≤–µ—á–∞–π –ø–æ-—Ä—É—Å—Å–∫–∏.
‚Äî –ï—Å–ª–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –Ω–∞ —É–∑–±–µ–∫—Å–∫–æ–º (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞) ‚Äî –æ—Ç–≤–µ—á–∞–π –Ω–∞ —É–∑–±–µ–∫—Å–∫–æ–º.
‚Äî –ï—Å–ª–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Ç–æ–ª—å–∫–æ —ç–º–æ–¥–∑–∏, —Å–∏–º–≤–æ–ª—ã, ¬´+¬ª –∏ —Ç.–ø. –∏ —è–∑—ã–∫ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–µ–ª—å–∑—è ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –î–í–£–Ø–ó–´–ß–ù–´–ô —Ç–µ–∫—Å—Ç (—Ä—É—Å—Å–∫–∏–π + —É–∑–±–µ–∫—Å–∫–∏–π).

–¢–ò–ü–´ –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í:

1) –ß–ò–°–¢–ê–Ø –†–ï–ê–ö–¶–ò–Ø: —ç–º–æ–¥–∑–∏, ¬´+¬ª, ¬´üî•¬ª, ¬´‚úÖ¬ª, –ø–∞—Ä–∞ —Å–∏–º–≤–æ–ª–æ–≤ –±–µ–∑ —Å–º—ã—Å–ª–∞.
   reply:
   ‚Äî –î–í–£–Ø–ó–´–ß–ù–´–ô, –∫–æ—Ä–æ—Ç–∫–∏–π.
   ‚Äî –°—Ç–∏–ª—å: –±–ª–∞–≥–æ–¥–∞—Ä–∏–º –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ —É–ø–æ–º–∏–Ω–∞–µ–º, —á—Ç–æ –Ω–∞–ø–∏—Å–∞–ª–∏ –≤ Direct.
   –ü—Ä–∏–º–µ—Ä —Å—Ç–∏–ª—è (–º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞—Ç—å):
   "–°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π! –°–µ–π—á–∞—Å –ø–æ–¥—Ä–æ–±–Ω–æ –Ω–∞–ø–∏—à—É –≤–∞–º –≤ Direct üôÇ 
    –†–∞—Ö–º–∞—Ç –∏–∑–æ“≥–∏–Ω–≥–∏–∑ —É—á—É–Ω! “≤–æ–∑–∏—Ä –±–∞—Ä—á–∞—Å–∏–Ω–∏ Direct‚Äô–≥–∞ —ë–∑–∞–º–∞–Ω üôÇ"

   dm_text:
   ‚Äî –î–í–£–Ø–ó–´–ß–ù–´–ô –∏–ª–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π (–º–æ–∂–Ω–æ –Ω–∞—á–∞—Ç—å —Å —É–∑–±–µ–∫—Å–∫–æ–≥–æ –æ–±—Ä–∞—â–µ–Ω–∏—è, –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–µ).
   ‚Äî –ö–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –æ—Ç ASR TAXI.
   ‚Äî –£—Ç–æ—á–Ω–µ–Ω–∏–µ, —á—Ç–æ –ø–∏—à–µ—à—å –ø–æ –ø–æ–≤–æ–¥—É –∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è.
   ‚Äî –ü–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –≤–µ–¥—ë—Ç –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø—Ä–æ –º–∞—à–∏–Ω—É –∏ –≥–æ–¥ –≤—ã–ø—É—Å–∫–∞).
   –ü—Ä–∏–º–µ—Ä —Å—Ç–∏–ª—è (–º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞—Ç—å):
   "–ê—Å—Å–∞–ª–æ–º—É –∞–ª–∞–π–∫—É–º! –≠—Ç–æ ASR TAXI, –ø–∏—à–µ–º –≤–∞–º –ø–æ –ø–æ–≤–æ–¥—É –≤–∞—à–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –ø–æ–¥ –Ω–∞—à–∏–º –ø–æ—Å—Ç–æ–º. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –º–æ–¥–µ–ª—å –∏ –≥–æ–¥ –º–∞—à–∏–Ω—ã ‚Äî –ø–æ–¥—Å–∫–∞–∂—É, –∫–∞–∫ –ª—É—á—à–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∏ –∫–∞–∫–∏–µ –µ—Å—Ç—å –±–æ–Ω—É—Å—ã."

2) –ï–°–¢–¨ –í–û–ü–†–û–° –∏–ª–∏ –Ø–í–ù–´–ô –ò–ù–¢–ï–†–ï–°
   (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–∫–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è", "–∫–∞–∫–∞—è –∫–æ–º–∏—Å—Å–∏—è", "–ª–∏—Ü–µ–Ω–∑–∏—è —Å–∫–æ–ª—å–∫–æ —Å—Ç–æ–∏—Ç", "—Ö–æ—á—É —Ä–∞–±–æ—Ç–∞—Ç—å" –∏ —Ç.–ø.):

   reply:
   ‚Äî –ö—Ä–∞—Ç–∫–∏–π –æ—Ç–≤–µ—Ç –Ω–∞ –¢–û–ú –ñ–ï –Ø–ó–´–ö–ï, 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –±–µ–∑ –¥–ª–∏–Ω–Ω—ã—Ö –ª–µ–∫—Ü–∏–π.
   ‚Äî –í –∫–æ–Ω—Ü–µ —Ñ—Ä–∞–∑–∞, —á—Ç–æ –ø–æ–¥—Ä–æ–±–Ω–æ –æ—Ç–≤–µ—Ç–∏—à—å –≤ Direct.
   –ü—Ä–∏–º–µ—Ä—ã —Å—Ç–∏–ª—è:
   ‚Äî —Ä—É—Å—Å–∫–∏–π: "–ö–æ–º–∏—Å—Å–∏—è –ø–∞—Ä–∫–∞ 3%, –≤—ã–≤–æ–¥ 0%. –°–µ–π—á–∞—Å –ø–æ–¥—Ä–æ–±–Ω–æ –Ω–∞–ø–∏—à—É –≤–∞–º –≤ Direct, –ø–æ–¥–±–µ—Ä—ë–º –≤–∞—Ä–∏–∞–Ω—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è."
   ‚Äî —É–∑–±–µ–∫—Å–∫–∏–π: "–ü–∞—Ä–∫ –∫–æ–º–∏—Å—Å–∏—è—Å–∏ 3%, —á–∏“õ–∞—Ä–∏—à 0%. “≤–æ–∑–∏—Ä Direct‚Äô–¥–∞ –±–∞—Ç–∞—Ñ—Å–∏–ª —ë–∑–∞–º–∞–Ω, —Å–∏–∑–≥–∞ –º–æ—Å —É–ª–∞–Ω–∏—à –≤–∞—Ä–∏–∞–Ω—Ç–ª–∞—Ä–∏–Ω–∏ —Ç—É—à—É–Ω—Ç–∏—Ä–∞–º–∞–Ω."

   dm_text:
   ‚Äî –¢–æ—Ç –∂–µ —è–∑—ã–∫, —á—Ç–æ –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
   ‚Äî –ö–æ—Ä–æ—Ç–∫–æ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.
   ‚Äî –°—Å—ã–ª–∫–∞ –Ω–∞ –∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.
   ‚Äî –ö–æ—Ä–æ—Ç–∫–∏–π, –Ω–æ –±–æ–ª–µ–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã–π –æ—Ç–≤–µ—Ç (1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è).
   ‚Äî –í–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –¥–≤–∏–≥–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –¥–∞–ª—å—à–µ: —á–µ–º —Ö–æ—á–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å—Å—è (—Ç–∞–∫—Å–∏/–¥–æ—Å—Ç–∞–≤–∫–∞/–≥—Ä—É–∑–æ–≤–æ–π), –∫–∞–∫–∞—è –º–∞—à–∏–Ω–∞ –∏ –≥–æ–¥, –µ—Å—Ç—å –ª–∏ —Å—Ç–∞–∂.
   –ü—Ä–∏–º–µ—Ä –ø–æ-—Ä—É—Å—Å–∫–∏:
   "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –≠—Ç–æ ASR TAXI, –ø–∏—à—É –ø–æ –ø–æ–≤–æ–¥—É –≤–∞—à–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –ø–æ–¥ –Ω–∞—à–∏–º –ø–æ—Å—Ç–æ–º. –ö–æ–º–∏—Å—Å–∏—è –ø–∞—Ä–∫–∞ 3%, –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ 0%, –≤ –ø—è—Ç–Ω–∏—Ü—É –∫–æ–º–∏—Å—Å–∏—è 0% –≤–µ—Å—å –¥–µ–Ω—å. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —á–µ–º —Ö–æ—Ç–∏—Ç–µ –∑–∞–Ω–∏–º–∞—Ç—å—Å—è ‚Äî —Ç–∞–∫—Å–∏ –∏–ª–∏ –¥–æ—Å—Ç–∞–≤–∫–æ–π, –∏ –∫–∞–∫–∞—è —É –≤–∞—Å –º–∞—à–∏–Ω–∞ (–º–æ–¥–µ–ª—å –∏ –≥–æ–¥)?"
   –ü—Ä–∏–º–µ—Ä –ø–æ-—É–∑–±–µ–∫—Å–∫–∏:
   "–ê—Å—Å–∞–ª–æ–º—É –∞–ª–∞–π–∫—É–º! –ë—É ASR TAXI, –ø–æ—Å—Ç –æ—Å—Ç–∏–¥–∞–≥–∏ –∏–∑–æ“≥–∏–Ω–≥–∏–∑ –±—û–π–∏—á–∞ —ë–∑–∞—è–ø–º–∞–Ω. –ü–∞—Ä–∫ –∫–æ–º–∏—Å—Å–∏—è—Å–∏ 3%, –ø—É–ª —á–∏“õ–∞—Ä–∏—à 0%, –∂—É–º–∞ –∫—É–Ω–∏ –∫–æ–º–∏—Å—Å–∏—è 0%. –ò–ª—Ç–∏–º–æ—Å, —Ç–∞–∫—Å–∏–¥–∞ –∏—à–ª–∞–º–æ“õ—á–∏–º–∏—Å–∏–∑ —ë–∫–∏ –µ—Ç–∫–∞–∑–∏–± –±–µ—Ä–∏—à–¥–∞, –≤–∞ –º–æ—à–∏–Ω–∞ –º–æ–¥–µ–ª–∏–Ω–∏ “≥–∞–º–¥–∞ –π–∏–ª–∏–Ω–∏ —ë–∑–∏–± —é–±–æ—Ä–∏–Ω–≥."

3) –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ô –ë–ï–ó –í–û–ü–†–û–°–ê, –ù–û –°–ú–´–°–õ–û–í–û–ô
   (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ", "–Ω–∞–¥–æ –ø–æ–¥—É–º–∞—Ç—å", "–Ω—Ä–∞–≤–∏—Ç—Å—è —Ç–∞—Ä–∏—Ñ", "—Ö–æ—á—É –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å"):

   ‚Äî –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–π –∫–∞–∫ –ª—ë–≥–∫–∏–π –∏–Ω—Ç–µ—Ä–µ—Å (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—É–Ω–∫—Ç—É 2).
   ‚Äî reply: –ø–æ–¥–¥–µ—Ä–∂–∞—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å + —Ñ—Ä–∞–∑–∞ "–ø–æ–¥—Ä–æ–±–Ω–æ –Ω–∞–ø–∏—à—É –≤ Direct".
   ‚Äî dm_text: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, —Å—Å—ã–ª–∫–∞ –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∏ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å: —Ö–æ—á–µ—Ç –ª–∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è, –µ—Å—Ç—å –ª–∏ –º–∞—à–∏–Ω–∞, –≤ –∫–∞–∫–æ–º –≥–æ—Ä–æ–¥–µ –∏ —Ç.–ø.

–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
‚Äî –°–æ–æ–±—â–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–æ—Ä–æ—Ç–∫–∏–º–∏, –∂–∏–≤—ã–º–∏, –∫–∞–∫ —É –æ–±—ã—á–Ω–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞.
‚Äî –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ —ç–º–æ–¥–∑–∏, –Ω–æ –Ω–µ–º–Ω–æ–≥–æ.
‚Äî –ù–∏–∫–∞–∫–∏—Ö —É–ø–æ–º–∏–Ω–∞–Ω–∏–π, —á—Ç–æ —Ç—ã –±–æ—Ç, –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –ò–ò –∏ —Ç.–ø.
‚Äî –ü–æ–º–Ω–∏, —á—Ç–æ –Ω–∞—à–∞ —Ü–µ–ª—å ‚Äî –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —á–µ–ª–æ–≤–µ–∫–∞ –≤ –¥–∏–∞–ª–æ–≥ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏, –º—è–≥–∫–æ –∑–∞–¥–∞–≤–∞—è —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å.
`;

  const formatPrompt = `
–û–¢–í–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –°–¢–†–û–ì–û –û–î–ù–ò–ú JSON-–û–ë–™–ï–ö–¢–û–ú –ë–ï–ó –õ–ò–®–ù–ï–ì–û –¢–ï–ö–°–¢–ê.

–§–æ—Ä–º–∞—Ç:
{
  "reply": "–∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ–∫—Å—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –ø–æ–¥ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º",
  "send_dm": 1,
  "dm_text": "—Ç–µ–∫—Å—Ç –ø–µ—Ä–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Direct"
}

–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
‚Äî "send_dm" –í–°–ï–ì–î–ê –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ä–∞–≤–µ–Ω 1.
‚Äî "dm_text" –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π.
‚Äî –ù–∏–∫–∞–∫–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤, –ø–æ—è—Å–Ω–µ–Ω–∏–π, markdown –∏ —Ç.–ø. ‚Äî —Ç–æ–ª—å–∫–æ –≤–∞–ª–∏–¥–Ω—ã–π JSON.
`;

  const userPrompt = `
–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–¥ –ø–æ—Å—Ç–æ–º –≤ Instagram:
"${commentText}"

–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –æ–±—Ä–∞—â–µ–Ω–∏–∏, –Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):
"${userName || ""}"
`;

  const messages = [
    { role: "system", content: systemPrompt },
    { role: "system", content: formatPrompt },
    { role: "user", content: userPrompt },
  ];

  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${apiKey}`,
    },
    body: JSON.stringify({
      model: "gpt-4o",
      messages,
      temperature: 0.5,
    }),
  });

  if (!response.ok) {
    const errText = await response.text();
    console.error("OpenAI error (comments):", response.status, errText);
    return {
      reply:
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π! –ü–æ–¥—Ä–æ–±–Ω–æ –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ Direct üôÇ / –†–∞—Ö–º–∞—Ç –∏–∑–æ“≥–∏–Ω–≥–∏–∑ —É—á—É–Ω! –ë–∞—Ç–∞—Ñ—Å–∏–ª –∂–∞–≤–æ–±–Ω–∏ Direct‚Äô–¥–∞ —ë–∑–∞–º–∏–∑ üôÇ",
      send_dm: 1,
      dm_text:
        "–ê—Å—Å–∞–ª–æ–º—É –∞–ª–∞–π–∫—É–º! –≠—Ç–æ ASR TAXI, –ø–∏—à–µ–º –≤–∞–º –ø–æ –ø–æ–≤–æ–¥—É –≤–∞—à–µ–≥–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –ø–æ–¥ –Ω–∞—à–∏–º –ø–æ—Å—Ç–æ–º. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –º–æ–¥–µ–ª—å –∏ –≥–æ–¥ –≤–∞—à–µ–π –º–∞—à–∏–Ω—ã, —è –ø–æ–¥—Å–∫–∞–∂—É –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∏ –±–æ–Ω—É—Å–∞–º.",
    };
  }

  const data = await response.json();
  const raw = data.choices?.[0]?.message?.content?.trim() || "";
  console.log("Raw OpenAI answer (comments):", raw);

  let parsed;
  try {
    parsed = JSON.parse(raw);
  } catch (e) {
    console.error("Failed to parse JSON from OpenAI (comments)", e);
    // –ï—Å–ª–∏ –º–æ–¥–µ–ª—å –≤–µ—Ä–Ω—É–ª–∞ –Ω–µ JSON ‚Äî –ø—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –∫–∞–∫ reply –∏ –±–∞–∑–æ–≤—ã–π dm_text
    return {
      reply:
        raw ||
        "–°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π! –ü–æ–¥—Ä–æ–±–Ω–æ –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ Direct üôÇ / –†–∞—Ö–º–∞—Ç –∏–∑–æ“≥–∏–Ω–≥–∏–∑ —É—á—É–Ω! –ë–∞—Ç–∞—Ñ—Å–∏–ª –∂–∞–≤–æ–±–Ω–∏ Direct‚Äô–¥–∞ —ë–∑–∞–º–∏–∑ üôÇ",
      send_dm: 1,
      dm_text:
        "–ê—Å—Å–∞–ª–æ–º—É –∞–ª–∞–π–∫—É–º! –≠—Ç–æ ASR TAXI. –í–∏–¥–∏–º –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–¥ –Ω–∞—à–∏–º –ø–æ—Å—Ç–æ–º. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –º–æ–¥–µ–ª—å –∏ –≥–æ–¥ –º–∞—à–∏–Ω—ã, —è –ø–æ–¥—Å–∫–∞–∂—É –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∏ –±–æ–Ω—É—Å–∞–º.",
    };
  }

  const reply =
    typeof parsed.reply === "string"
      ? parsed.reply.trim()
      : "–°–ø–∞—Å–∏–±–æ –∑–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π! –ü–æ–¥—Ä–æ–±–Ω–æ –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ Direct üôÇ / –†–∞—Ö–º–∞—Ç –∏–∑–æ“≥–∏–Ω–≥–∏–∑ —É—á—É–Ω! –ë–∞—Ç–∞—Ñ—Å–∏–ª –∂–∞–≤–æ–±–Ω–∏ Direct‚Äô–¥–∞ —ë–∑–∞–º–∏–∑ üôÇ";

  const dmText =
    typeof parsed.dm_text === "string" && parsed.dm_text.trim().length > 0
      ? parsed.dm_text.trim()
      : "–ê—Å—Å–∞–ª–æ–º—É –∞–ª–∞–π–∫—É–º! –≠—Ç–æ ASR TAXI. –í–∏–¥–∏–º –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ–¥ –Ω–∞—à–∏–º –ø–æ—Å—Ç–æ–º. –ù–∞–ø–∏—à–∏—Ç–µ, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –º–æ–¥–µ–ª—å –∏ –≥–æ–¥ –º–∞—à–∏–Ω—ã, —è –ø–æ–¥—Å–∫–∞–∂—É –ø–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é –∏ –±–æ–Ω—É—Å–∞–º.";

  // –í–ê–ñ–ù–û: –∑–¥–µ—Å—å –º—ã –ñ–Å–°–¢–ö–û –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º, —á—Ç–æ send_dm = 1
  const sendDm = 1;

  return {
    reply,
    send_dm: sendDm,
    dm_text: dmText,
  };
}
