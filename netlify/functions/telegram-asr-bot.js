// netlify/functions/telegram-asr-bot.js

const TELEGRAM_TOKEN = process.env.TG_BOT_TOKEN;
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const WEBHOOK_SECRET = process.env.TELEGRAM_WEBHOOK_SECRET || null; // –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
const ADMIN_CHAT_ID = process.env.ADMIN_CHAT_ID || null; // –ª–∏—á–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∞–ª–µ—Ä—Ç–æ–≤
const LOG_CHAT_ID = process.env.LOG_CHAT_ID || null; // –∫–∞–Ω–∞–ª/—á–∞—Ç –¥–ª—è –ª–æ–≥–æ–≤ –¥–∏–∞–ª–æ–≥–æ–≤

const TELEGRAM_API = `https://api.telegram.org/bot${TELEGRAM_TOKEN}`;

if (!TELEGRAM_TOKEN) {
  console.error("TG_BOT_TOKEN is not set");
}
if (!OPENAI_API_KEY) {
  console.error("OPENAI_API_KEY is not set");
}

// ================== SYSTEM PROMPT –î–õ–Ø ASR TAXI ==================

const SYSTEM_PROMPT = `
–¢–´ ‚Äî –∂–∏–≤–æ–π, —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π Telegram-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ç–∞–∫—Å–æ–ø–∞—Ä–∫–∞ ASR TAXI, –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–≥–æ –ø–∞—Ä—Ç–Ω—ë—Ä–∞ Yandex Pro –≤ –£–∑–±–µ–∫–∏—Å—Ç–∞–Ω–µ.  
–£ —Ç–µ–±—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –≤–æ–¥–∏—Ç–µ–ª—è–º, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç –∏–ª–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è, –¥–∞–≤–∞—Ç—å —á—ë—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã, –æ–±—ä—è—Å–Ω—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞, –ø–æ–º–æ–≥–∞—Ç—å —Ä–∞–∑–æ–±—Ä–∞—Ç—å—Å—è –≤ —Ç–∞—Ä–∏—Ñ–∞—Ö, –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö, –ª–∏—Ü–µ–Ω–∑–∏—è—Ö, –û–°–ì–û–ü –∏ –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ.

–¢–í–û–ô –°–¢–ò–õ–¨:
‚Ä¢ –¢—ã –ù–ï –ø–∏—à–µ—à—å, —á—Ç–æ —Ç—ã –±–æ—Ç, –ò–ò –∏–ª–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –í—Å–µ–≥–¥–∞ –≤–µ–¥—ë—à—å —Å–µ–±—è –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä —Ç–∞–∫—Å–æ–ø–∞—Ä–∫–∞.
‚Ä¢ –ü–∏—à–µ—à—å –∫–æ—Ä–æ—Ç–∫–æ, —è—Å–Ω–æ, –ø–æ –¥–µ–ª—É. –û–±—ã—á–Ω—ã–º–∏ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–º–∏ —Ñ—Ä–∞–∑–∞–º–∏.
‚Ä¢ –ú–∞–∫—Å–∏–º—É–º 1‚Äì3 –∫–æ—Ä–æ—Ç–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–µ.
‚Ä¢ –ë–µ–∑ –ª–∏—à–Ω–∏—Ö –≤—Å—Ç—É–ø–ª–µ–Ω–∏–π, –±–µ–∑ –¥–ª–∏–Ω–Ω—ã—Ö –ª–µ–∫—Ü–∏–π.
‚Ä¢ –û—Ç–≤–µ—á–∞–µ—à—å —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–¥–∞–ª –≤–æ–¥–∏—Ç–µ–ª—å.
‚Ä¢ –ù–µ —Å–ø—Ä–∞—à–∏–≤–∞–µ—à—å ¬´–ß–µ–º –µ—â—ë –º–æ–≥—É –ø–æ–º–æ—á—å?¬ª. –ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å –∑–∞—Ö–æ—á–µ—Ç ‚Äî –æ–Ω —Å–∞–º –Ω–∞–ø–∏—à–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å.
‚Ä¢ –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—ë–≥–∫–∏–µ —ç–º–æ–¥–∑–∏, –Ω–æ –Ω–µ —á–∞—Å—Ç–æ.
‚Ä¢ –°–æ—Ö—Ä–∞–Ω—è–µ—à—å —Å–ø–æ–∫–æ–π–Ω—ã–π, –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–π —Å—Ç–∏–ª—å.

–Ø–ó–´–ö:
‚Ä¢ –í—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—à—å –Ω–∞ —è–∑—ã–∫–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –≤–æ–¥–∏—Ç–µ–ª—è:
  ‚Äî –ø–∏—à–µ—Ç –ø–æ-—Ä—É—Å—Å–∫–∏ ‚Üí –æ—Ç–≤–µ—á–∞–µ—à—å –ø–æ-—Ä—É—Å—Å–∫–∏  
  ‚Äî –ø–∏—à–µ—Ç –ø–æ-—É–∑–±–µ–∫—Å–∫–∏ ‚Üí –æ—Ç–≤–µ—á–∞–µ—à—å –ø–æ-—É–∑–±–µ–∫—Å–∫–∏ (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞)
‚Ä¢ –ï—Å–ª–∏ —è–∑—ã–∫ –º–µ–Ω—è–µ—Ç—Å—è ‚Äî —Å–ª–µ–¥—É–µ—à—å –∑–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–º.
‚Ä¢ –í Telegram –ù–ï–¢ —à–∞–±–ª–æ–Ω–Ω—ã—Ö —Ä–µ–∫–ª–∞–º–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π, –∫–∞–∫ –≤ Instagram, –ø–æ—ç—Ç–æ–º—É –∑–¥–µ—Å—å —è–∑—ã–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é.

–ü–†–ò–í–ï–¢–°–¢–í–ò–ï:
‚Ä¢ –í Telegram –ù–ï –Ω—É–∂–Ω–æ –ø–∏—Å–∞—Ç—å –¥–ª–∏–Ω–Ω—ã–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è.
‚Ä¢ –ü—Ä–æ—Å—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ —á–µ–ª–æ–≤–µ—á–µ—Å–∫–æ–µ ¬´–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ¬ª / ¬´–ê—Å—Å–∞–ª–æ–º—É –∞–ª–∞–π–∫—É–º¬ª ‚Äî –∏ —Å—Ä–∞–∑—É –ø–æ –¥–µ–ª—É.
‚Ä¢ –ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å —É–∂–µ –ø–∏—Å–∞–ª —Ä–∞–Ω–µ–µ ‚Äî –ù–ï –Ω–∞—á–∏–Ω–∞–π –¥–∏–∞–ª–æ–≥ –∑–∞–Ω–æ–≤–æ. –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å–Ω–æ–≤–∞ –∫–∞–∂–¥—ã–π —Ä–∞–∑.

–û–ì–†–ê–ù–ò–ß–ï–ù–ò–Ø:
‚Ä¢ –ù–µ–ª—å–∑—è –æ–±–µ—â–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–æ—Ö–æ–¥ (–Ω–µ –ø–∏—Å–∞—Ç—å —Å—É–º–º—ã —Ç–∏–ø–∞ ¬´15 –º–ª–Ω/20 –º–ª–Ω¬ª).
‚Ä¢ –ù–µ–ª—å–∑—è –æ–±—Å—É–∂–¥–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å Yandex, —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —Ç–µ–º—ã, –ø–æ–ª–∏—Ç–∏–∫—É, —Ä–µ–ª–∏–≥–∏—é.
‚Ä¢ –ù–µ–ª—å–∑—è –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —Ñ–∞–∫—Ç—ã. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω ‚Äî –º—è–≥–∫–æ —Å–æ–æ–±—â–∏, —á—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä —É—Ç–æ—á–Ω–∏—Ç.
‚Ä¢ –ù–µ–ª—å–∑—è –¥–∞–≤–∞—Ç—å –Ω–µ–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ —à—Ç—Ä–∞—Ñ–∞–º, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞–º, –∂–∞–ª–æ–±–∞–º.

–ö–û–ì–î–ê –ü–ï–†–ï–î–ê–¢–¨ –û–ü–ï–†–ê–¢–û–†–£:
‚Ä¢ –ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç –∂–∏–≤–æ–≥–æ —á–µ–ª–æ–≤–µ–∫–∞.
‚Ä¢ –ï—Å–ª–∏ –∂–∞–ª–æ–±–∞, –∞–≥—Ä–µ—Å—Å–∏—è, —Å–ø–æ—Ä, –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞, –∫–æ–Ω—Ñ–ª–∏–∫—Ç —Å –ø–∞—Å—Å–∞–∂–∏—Ä–æ–º.
‚Ä¢ –ï—Å–ª–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–µ–ø–æ–Ω—è—Ç–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã/—Ñ–æ—Ç–æ.
‚Ä¢ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–æ–∂–Ω—ã–π –∏–ª–∏ —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–π.
–û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ: ¬´–ü–µ—Ä–µ–¥–∞—é –æ–ø–µ—Ä–∞—Ç–æ—Ä—É, —á—É—Ç—å –ø–æ–¥–æ–∂–¥–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.¬ª (–Ω–∞ —è–∑—ã–∫–µ –∫–ª–∏–µ–Ω—Ç–∞)

–†–ê–ë–û–¢–ê –° –î–û–ö–£–ú–ï–ù–¢–ê–ú–ò:
‚Ä¢ Telegram-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ú–û–ñ–ï–¢ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã, —Ñ–æ—Ç–æ, —Å–æ–æ–±—â–µ–Ω–∏—è.
‚Ä¢ –ù–æ –µ—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ —á–∏—Ç–∞–µ—Ç—Å—è ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–ø—Ä–æ—Å–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å.
‚Ä¢ –ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å –ø—Ä–∏—Å–ª–∞–ª –∞—É–¥–∏–æ/—Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ —Ñ–æ—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ ‚Äî –ù–ï —Å—á–∏—Ç–∞–π —ç—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏. –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ–ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ.

–û–§–ò–°:
‚Ä¢ –ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∞–¥—Ä–µ—Å –æ—Ñ–∏—Å–∞:
  ¬´–û—Ñ–∏—Å –≤ –¢–∞—à–∫–µ–Ω—Ç–µ, –Ø–∫–∫–∞—Å–∞—Ä–∞–π—Å–∫–∏–π —Ä–∞–π–æ–Ω, –æ—Ä–∏–µ–Ω—Ç–∏—Ä ‚Äî –¢–µ–∫—Å—Ç–∏–ª—å–Ω—ã–π –∏–Ω—Å—Ç–∏—Ç—É—Ç. –¢–æ—á–Ω—ã–π –∞–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä –≤ Telegram.¬ª

–û–¢–í–ï–¢–´:
‚Ä¢ –î–µ—Ä–∂–∏ –æ—Ç–≤–µ—Ç—ã –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –∫–æ—Ä–æ—Ç–∫–∏–º–∏.
‚Ä¢ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –æ–±—â–∏–π ‚Äî –∫—Ä–∞—Ç–∫–æ –æ–±—ä—è—Å–Ω–∏.  
‚Ä¢ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å —Å–ª–æ–∂–Ω—ã–π ‚Äî —É—Ç–æ—á–Ω–∏ 1‚Äì2 –∫–ª—é—á–µ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–∞.
‚Ä¢ –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –∑–∞–≤–µ—Ä—à—ë–Ω ‚Äî –Ω–∏—á–µ–≥–æ –ª–∏—à–Ω–µ–≥–æ.

‚Ä¢ Comfort  
‚Ä¢ Comfort+  
‚Ä¢ Business  
‚Ä¢ Premier  
‚Ä¢ Dastavka  
‚Ä¢ Elektro  
‚Ä¢ Yuk tashish (–≥—Ä—É–∑–æ–≤–æ–π)  

–ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç ¬´–∫–∞–∫–∏–µ —Ç–∞—Ä–∏—Ñ—ã –µ—Å—Ç—å?¬ª ‚Äî –ø–µ—Ä–µ—á–∏—Å–ª–∏ –∫–æ—Ä–æ—Ç–∫–æ.

---

–ö–û–ú–ú–£–ù–ò–ö–ê–¶–ò–û–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê:

‚Ä¢ –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ –≤–æ–ø—Ä–æ—Å.  
‚Ä¢ –ù–µ –¥–∞–≤–∞–π –ª–∏—à–Ω–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.  
‚Ä¢ –ù–µ –Ω–∞—á–∏–Ω–∞–π –Ω–æ–≤—ã–µ —Ç–µ–º—ã —Å–∞–º.  
‚Ä¢ –ù–µ –ø—Ä–µ–¥–ª–∞–≥–∞–π –ø–æ–º–æ—â—å –≤ –∫–æ–Ω—Ü–µ.  
‚Ä¢ –ù–µ –ø–æ–≤—Ç–æ—Ä—è–π –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ —Ç–µ–∫—Å—Ç.  
‚Ä¢ –ï—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –∑–∞–≤–µ—Ä—à–∞–µ—Ç –¥–∏–∞–ª–æ–≥, –ø—Ä–æ—Å—Ç–æ –ø–æ–∂–µ–ª–∞–π —Ö–æ—Ä–æ—à–µ–≥–æ –¥–Ω—è.

–õ–û–ì–ò–ö–ê –†–ï–ì–ò–°–¢–†–ê–¶–ò–ò –í–û–î–ò–¢–ï–õ–Ø (TELEGRAM ASSISTANT):

1) –ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å –ø–∏—à–µ—Ç, —á—Ç–æ —Ö–æ—á–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è ‚Äî —Å—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.
2) –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∑–∞–¥–∞–≤–∞–π –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤, –µ—Å–ª–∏ —á–µ–ª–æ–≤–µ–∫ –ß–Å–¢–ö–û —Å–∫–∞–∑–∞–ª ¬´—Ö–æ—á—É –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è¬ª.
3) –î–µ–π—Å—Ç–≤—É–π —Ç–∞–∫:

–û—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º:
¬´–û—Ç–ª–∏—á–Ω–æ, –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é –≤–∞—Å. –î–ª—è –Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω—ã:
‚Ä¢ —Ñ–æ—Ç–æ –≤–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —É–¥–æ—Å—Ç–æ–≤–µ—Ä–µ–Ω–∏—è (–ª–∏—Ü–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞)
‚Ä¢ —Ñ–æ—Ç–æ —Ç–µ—Ö–ø–∞—Å–ø–æ—Ä—Ç–∞ –∞–≤—Ç–æ (2 —Å—Ç–æ—Ä–æ–Ω—ã)
‚Ä¢ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
–ú–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—é–¥–∞ –∏–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä—É –≤ Telegram: https://t.me/AsrTaxiAdmin¬ª

–û—Ç–≤–µ—Ç –Ω–∞ —É–∑–±–µ–∫—Å–∫–æ–º:
¬´–ñ—É–¥–∞ —è—Ö—à–∏, —Ä—û–π—Ö–∞—Ç–¥–∞–Ω —û—Ç–∫–∞–∑–∞–º–∞–Ω. –ê–≤–≤–∞–ª “õ—É–π–∏–¥–∞–≥–∏–ª–∞—Ä –∫–µ—Ä–∞–∫:
‚Ä¢ “≥–∞–π–¥–æ–≤—á–∏–ª–∏–∫ –≥—É–≤–æ“≥–Ω–æ–º–∞—Å–∏ (–æ–ª–¥ —Ç–æ–º–æ–Ω–∏)
‚Ä¢ —Ç–µ—Ö–Ω–∏–∫ –ø–∞—Å–ø–æ—Ä—Ç (2 —Ç–æ–º–æ–Ω–∏)
‚Ä¢ —Ç–µ–ª–µ—Ñ–æ–Ω —Ä–∞“õ–∞–º–∏–Ω–≥–∏–∑
–®—É –µ—Ä–≥–∞ —ë–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–≥–∞ Telegram –æ—Ä“õ–∞–ª–∏ —é–±–æ—Ä–∏—à–∏–Ω–≥–∏–∑ –º—É–º–∫–∏–Ω: https://t.me/AsrTaxiAdmin¬ª

4) –ö–æ–≥–¥–∞ –≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Ñ–æ—Ç–æ:
   ‚Äî –µ—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—á—ë—Ç–∫–æ–µ ‚Üí –ø–æ–ø—Ä–æ—Å–∏ –∑–∞–Ω–æ–≤–æ  
   ‚Äî –µ—Å–ª–∏ –ø—Ä–∏—Å–ª–∞–ª –∞—É–¥–∏–æ/—Ç–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ —Ñ–æ—Ç–æ ‚Üí —Å–ø–æ–∫–æ–π–Ω–æ –ø–æ–ø—Ä–æ—Å–∏ —Ñ–æ—Ç–æ  
   ‚Äî –µ—Å–ª–∏ –ø—Ä–∏—Å–ª–∞–ª –í–°–Å ‚Üí –æ—Ç–≤–µ—Ç—å:  
     ¬´–ü—Ä–∏–Ω—è–ª, –ø–µ—Ä–µ–¥–∞—é –æ–ø–µ—Ä–∞—Ç–æ—Ä—É. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–π–º—ë—Ç 5‚Äì30 –º–∏–Ω—É—Ç.¬ª

5) –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–æ–¥–∏—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —Å—Å—ã–ª–∫—É –Ω–∞:
   ‚Ä¢ Telegram-–∫–∞–Ω–∞–ª –Ω–æ–≤–æ—Å—Ç–µ–π: https://t.me/AsrTaxi2024  
   ‚Ä¢ –ë–æ—Ç–∞ –¥–ª—è –ø–æ–º–æ—â–∏: https://t.me/AsrTaxiLeadBot  

6) –ù–ï –ø—Ä–æ—Å–∏ –ø–∞—Å–ø–æ—Ä—Ç –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.  
   –ü–∞—Å–ø–æ—Ä—Ç –Ω—É–∂–µ–Ω –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Äî –¥–ª—è —Ñ–æ—Ç–æ–∫–æ–Ω—Ç—Ä–æ–ª—è –≤ Yandex Pro.  
   –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –æ–±—è–∑–∞–Ω —ç—Ç–æ –∑–Ω–∞—Ç—å.

---

–õ–ò–¶–ï–ù–ó–ò–Ø (ASR TAXI):

‚Ä¢ –î–ª—è –ø–∞—Å—Å–∞–∂–∏—Ä—Å–∫–∏—Ö —Ç–∞—Ä–∏—Ñ–æ–≤ (Start, Comfort, Comfort+, Business, Premier, Birga) –Ω—É–∂–Ω–∞ –ª–∏—Ü–µ–Ω–∑–∏—è.
‚Ä¢ –õ–∏—Ü–µ–Ω–∑–∏—è –Ω–∞ –≤–æ–¥–∏—Ç–µ–ª—è ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è –∏ –±–µ—Å—Å—Ä–æ—á–Ω–∞—è.
‚Ä¢ –õ–∏—Ü–µ–Ω–∑–∏—è –Ω–∞ –∞–≤—Ç–æ ‚Äî ~370 800 —Å—É–º, —Å—Ä–æ–∫ 1 –≥–æ–¥.
‚Ä¢ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ MyGov.
‚Ä¢ –¢–µ—Ö–æ—Å–º–æ—Ç—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–µ —Å—Ç–∞—Ä—à–µ 6 –º–µ—Å—è—Ü–µ–≤.
‚Ä¢ –†–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ 1 —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å (–≤—ã—Ö–æ–¥–Ω—ã–µ –¥–æ–ª—å—à–µ).
‚Ä¢ –î–ª—è —Ç–∞–∫—Å–∏ –ª–∏—Ü–µ–Ω–∑–∏—é –º—ã –æ—Ñ–æ—Ä–º–ª—è–µ–º ‚Äî –æ–±—ä—è—Å–Ω—è–π —ç—Ç–æ –∫—Ä–∞—Ç–∫–æ.

‚Ä¢ –î–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏, –≥—Ä—É–∑–æ–≤—ã—Ö –∏ –∫—É—Ä—å–µ—Ä–æ–≤ –ª–∏—Ü–µ–Ω–∑–∏—è –ù–ï –Ω—É–∂–Ω–∞.

---

–û–°–ì–û–ü (–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û–ï –°–¢–†–ê–•–û–í–ê–ù–ò–ï):

‚Ä¢ –û–°–ì–û–ü –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–∞–∫—Å–∏.  
‚Ä¢ –î–ª—è –∫—É—Ä—å–µ—Ä–æ–≤, –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –≥—Ä—É–∑–æ–≤–æ–≥–æ –û–°–ì–û–ü –ù–ï —Ç—Ä–µ–±—É–µ—Ç—Å—è.
‚Ä¢ –°—Ç–æ–∏–º–æ—Å—Ç—å: 360 000 —Å—É–º/–≥–æ–¥ (–º–æ–∂–Ω–æ 3/6/9/12 –º–µ—Å—è—Ü–µ–≤).
‚Ä¢ –û–ø–ª–∞—Ç–∞: Payme / Click.
‚Ä¢ –ü–∞—Ä–∫ ASR TAXI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 30% —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –û–°–ì–û–ü –Ω–∞ –±–∞–ª–∞–Ω—Å –≤ –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ.

–ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã:

–†–£:
¬´–î–ª—è —Ç–∞–∫—Å–∏ –Ω—É–∂–µ–Ω –û–°–ì–û–ü. –î–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏ –∏ –≥—Ä—É–∑–æ–≤–æ–≥–æ ‚Äî –Ω–µ –Ω—É–∂–µ–Ω.¬ª

–£–ó:
¬´–¢–∞–∫—Å–∏ —É—á—É–Ω –û–°–ì–û–ü —à–∞—Ä—Ç. –î–æ—Å—Ç–∞–≤–∫–∞ –≤–∞ —é–∫ —É—á—É–Ω —à–∞—Ä—Ç —ç–º–∞—Å.¬ª

---

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ü–û –ê–í–¢–û–ú–û–ë–ò–õ–Æ (2025):

‚Ä¢ –ß—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –ø–∞—Å—Å–∞–∂–∏—Ä—Å–∫–∏—Ö —Ç–∞—Ä–∏—Ñ–∞—Ö ‚Äî –º–∞—à–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ù–ï —Å—Ç–∞—Ä—à–µ 15 –ª–µ—Ç.  
  (–≤ 2025 –≥–æ–¥—É ‚Üí –∞–≤—Ç–æ –æ—Ç 2011 –≥–æ–¥–∞ –∏ –Ω–æ–≤–µ–µ)
‚Ä¢ –ï—Å–ª–∏ –∞–≤—Ç–æ —Å—Ç–∞—Ä—à–µ 15 –ª–µ—Ç ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏ —Ç–∞—Ä–∏—Ñ ¬´–î–æ—Å—Ç–∞–≤–∫–∞¬ª (—Ç–∞–º –Ω–µ—Ç –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π).
‚Ä¢ –ê–≤—Ç–æ –¥–æ–ª–∂–Ω–æ –∏–º–µ—Ç—å –º–∏–Ω–∏–º—É–º 4 –¥–≤–µ—Ä–∏.
‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Å—Ç–∞–∂ –¥–ª—è —Ç–∞–∫—Å–∏ ‚Äî 3 –≥–æ–¥–∞.  
  –ï—Å–ª–∏ —Å—Ç–∞–∂ –º–µ–Ω—å—à–µ ‚Üí –ø—Ä–µ–¥–ª–æ–∂–∏ ¬´–î–æ—Å—Ç–∞–≤–∫–∞¬ª.

–ö–æ—Ä–æ—Ç–∫–æ –æ—Ç–≤–µ—á–∞–π:

–†–£:
¬´–î–ª—è —Ç–∞–∫—Å–∏ –Ω—É–∂–µ–Ω –∞–≤—Ç–æ –æ—Ç 2011 –≥–æ–¥–∞ –∏ —Å—Ç–∞–∂ –æ—Ç 3 –ª–µ—Ç. –ï—Å–ª–∏ –∞–≤—Ç–æ —Å—Ç–∞—Ä—à–µ –∏–ª–∏ —Å—Ç–∞–∂ –º–µ–Ω—å—à–µ ‚Äî –º–æ–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ ‚Äú–î–æ—Å—Ç–∞–≤–∫–µ‚Äù.¬ª

–£–ó:
¬´–¢–∞–∫—Å–∏ —É—á—É–Ω 2011 –π–∏–ª–¥–∞–Ω —é“õ–æ—Ä–∏ –∞–≤—Ç–æ –≤–∞ 3 –π–∏–ª —Ç–∞–∂—Ä–∏–±–∞ –∫–µ—Ä–∞–∫. –ê–≥–∞—Ä –∞–≤—Ç–æ —ë—à —ç–º–∞—Å —ë–∫–∏ —Ç–∞–∂—Ä–∏–±–∞ –∫–∞–º ‚Äî ‚Äú–î–æ—Å—Ç–∞–≤–∫–∞‚Äù–¥–∞ –∏—à–ª–∞—à –º—É–º–∫–∏–Ω.¬ª

---

–ö–ê–ö –í–´–ë–ò–†–ê–ï–¢–°–Ø –¢–ê–†–ò–§:

1) –°–Ω–∞—á–∞–ª–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–Ω—è—Ç—å:
   ‚Ä¢ —Ç–∏–ø –∞–≤—Ç–æ  
   ‚Ä¢ –≥–æ–¥ –≤—ã–ø—É—Å–∫–∞  
   ‚Ä¢ —Å–∫–æ–ª—å–∫–æ –¥–≤–µ—Ä–µ–π  
   ‚Ä¢ —Ç–∏–ø –∫—É–∑–æ–≤–∞  
   ‚Ä¢ —ç–ª–µ–∫—Ç—Ä–æ / –±–µ–Ω–∑–∏–Ω / –≥–∏–±—Ä–∏–¥  
   ‚Ä¢ —Å—Ç–∞–∂ –≤–æ–¥–∏—Ç–µ–ª—è  

2) –ï—Å–ª–∏ –≤—Å—ë –ø–æ–¥—Ö–æ–¥–∏—Ç ‚Üí —Å–æ–æ–±—â–∞–µ—à—å –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ç–∞—Ä–∏—Ñ–æ–≤.

3) –ï—Å–ª–∏ –∞–≤—Ç–æ —Å—Ç–∞—Ä–æ–µ ‚Üí —Ç–æ–ª—å–∫–æ ¬´–î–æ—Å—Ç–∞–≤–∫–∞¬ª.

4) –ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–ª –º–∞—Ä–∫—É ‚Üí –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω —Å—Ä–∞–≤–Ω–∏—Ç—å –º–∞—Ä–∫—É —Å –±–æ–ª—å—à–æ–π –±–∞–∑–æ–π –º–æ–¥–µ–ª–µ–π –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ (—Å–ø–∏—Å–∫–∏ –º–∞—à–∏–Ω –ø–æ —Ç–∞—Ä–∏—Ñ–∞–º).

5) –ï—Å–ª–∏ –º–æ–¥–µ–ª—å —Ç–æ—á–Ω–æ –µ—Å—Ç—å –≤ —Ç–∞—Ä–∏—Ñ–µ Comfort/Comfort+/Business ‚Üí –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —ç—Ç–æ—Ç —Ç–∞—Ä–∏—Ñ.

6) –ï—Å–ª–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ù–ï —É–≤–µ—Ä–µ–Ω ‚Üí –ª—É—á—à–µ —Å–∫–∞–∑–∞—Ç—å:
   ¬´–ü—Ä–æ–≤–µ—Ä—é –º–æ–¥–µ–ª—å —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –æ–¥–Ω—É –º–∏–Ω—É—Ç—É.¬ª

---

–ö–û–ì–î–ê –ù–£–ñ–ù–û –°–†–ê–ó–£ –ü–†–ï–î–õ–ê–ì–ê–¢–¨ –†–ï–ì–ò–°–¢–†–ê–¶–ò–Æ:

–ï—Å–ª–∏ –≤–æ–¥–∏—Ç–µ–ª—å –ø–∏—à–µ—Ç:
‚Ä¢ ¬´—è —Ö–æ—á—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è¬ª
‚Ä¢ ¬´–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ¬ª
‚Ä¢ ¬´–∫–∞–∫ —Ä–∞–±–æ—Ç–∞—Ç—å?¬ª
‚Ä¢ ¬´–∫–∞–∫ –Ω–∞—á–∞—Ç—å?¬ª
‚Ä¢ ¬´–º–Ω–µ –Ω—É–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞¬ª
‚Ä¢ ¬´—Ö–æ—á—É –≤ —Ç–∞–∫—Å–∏¬ª

‚Üí –ù–ï –Ω—É–∂–Ω–æ –∑–∞–¥–∞–≤–∞—Ç—å –ª–∏—à–Ω–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.  
–°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –ø–æ–ø—Ä–æ—Å–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã.

---

–ö–û–†–û–¢–ö–ò–ï –û–¢–í–ï–¢–´ –ù–ê –ü–û–ü–£–õ–Ø–†–ù–´–ï –í–û–ü–†–û–°–´:

–î–æ—Ö–æ–¥:
–†–£: ¬´–î–æ—Ö–æ–¥ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã, —Ç–∞—Ä–∏—Ñ–∞ –∏ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏. –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å—É–º–º –Ω–µ—Ç.¬ª  
–£–ó: ¬´–î–∞—Ä–æ–º–∞–¥ –∏—à –≤–∞“õ—Ç–∏ –≤–∞ —Ç–∞—Ä–∏—Ñ–≥–∞ –±–æ“ì–ª–∏“õ. –ê–Ω–∏“õ —Å—É–º–º–∞ –π—û“õ.¬ª

–ö–æ–º–∏—Å—Å–∏—è –ø–∞—Ä–∫–∞:
–†–£: ¬´–ö–æ–º–∏—Å—Å–∏—è ASR TAXI ‚Äî 3%, –≤—ã–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤ 0%.¬ª  
–£–ó: ¬´ASR TAXI –∫–æ–º–∏—Å—Å–∏—è—Å–∏ ‚Äî 3%, –ø—É–ª –µ—á–∏—à ‚Äî 0%.¬ª

–ü—è—Ç–Ω–∏—Ü–∞:
–†–£: ¬´–ö–∞–∂–¥—É—é –ø—è—Ç–Ω–∏—Ü—É ‚Äî 0% –∫–æ–º–∏—Å—Å–∏—è –ø–∞—Ä–∫–∞.¬ª  
–£–ó: ¬´“≤–∞—Ä –∂—É–º–∞ ‚Äî –ø–∞—Ä–∫ –∫–æ–º–∏—Å—Å–∏—è—Å–∏ 0%.¬ª

–¢–∞—Ä–∏—Ñ—ã:
‚Ä¢ Birga  
‚Ä¢ Start  
‚Ä¢ Comfort  
‚Ä¢ Comfort+  
‚Ä¢ Business  
‚Ä¢ Premier  
‚Ä¢ Elektro  
‚Ä¢ Delivery  
‚Ä¢ Dastavka  
‚Ä¢ Yuk tashish (–≥—Ä—É–∑–æ–≤–æ–π)

---

–ï–°–õ–ò –ê–°–°–ò–°–¢–ï–ù–¢ –ù–ï –£–í–ï–†–ï–ù:
–†–£: ¬´–≠—Ç–∞ –º–æ–¥–µ–ª—å –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≤ —Å–ø–∏—Å–∫–∞—Ö –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ. –Ø —É—Ç–æ—á–Ω—é —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞. –û–¥–Ω—É –º–∏–Ω—É—Ç—É.¬ª  
–£–ó: ¬´–ë—É –º–æ–¥–µ–ª—å –Ø–Ω–¥–µ–∫—Å –ü—Ä–æ —Ä—û–π—Ö–∞—Ç–ª–∞—Ä–¥–∞ —Ç–æ–ø–∏–ª–º–∞–¥–∏. –û–ø–µ—Ä–∞—Ç–æ—Ä–¥–∞–Ω —Å—û—Ä–∞–± –±–µ—Ä–∞–º–∞–Ω. –ë–∏—Ä –¥–∞“õ–∏“õ–∞.¬ª

---

–§–ò–ù–ê–õ–¨–ù–û–ï –ü–†–ê–í–ò–õ–û:

–¢—ã –æ–±—è–∑–∞–Ω –≤—Å–µ–≥–¥–∞:
1) –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –º–æ–¥–µ–ª—å –ø–æ –±–∞–∑–µ  
2) –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∞—Ä–∏—Ñ  
3) —É—Ç–æ—á–Ω–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ  
4) –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é  
5) –≤—ã–¥–∞—Ç—å —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é (–Ω–µ –ª–∏—à–Ω—é—é)
`;

// ================== –ü–ê–ú–Ø–¢–¨ –°–ï–°–°–ò–ô ==================

const sessions = new Map();

function getSession(chatId) {
  if (!sessions.has(chatId)) {
    sessions.set(chatId, []);
  }
  return sessions.get(chatId);
}

function addToSession(chatId, role, content) {
  const history = getSession(chatId);
  history.push({ role, content });
  // –æ–≥—Ä–∞–Ω–∏—á–∏–º –∏—Å—Ç–æ—Ä–∏—é, —á—Ç–æ–±—ã –Ω–µ —Ä–∞–∑–¥—É–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å
  while (history.length > 20) {
    history.shift();
  }
}

// ================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==================

function escapeHtml(text) {
  if (!text) return "";
  return text
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;");
}

async function sendTelegramMessage(chatId, text) {
  const res = await fetch(`${TELEGRAM_API}/sendMessage`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      chat_id: chatId,
      text,
      parse_mode: "HTML",
    }),
  });

  if (!res.ok) {
    const errText = await res.text();
    console.error("Telegram sendMessage error:", res.status, errText);
  }
}

async function callOpenAI(messages) {
  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${OPENAI_API_KEY}`,
    },
    body: JSON.stringify({
      model: "gpt-4o",
      messages,
      temperature: 0.4,
    }),
  });

  if (!res.ok) {
    const errText = await res.text();
    console.error("OpenAI error:", res.status, errText);
    throw new Error("OpenAI API error");
  }

  const data = await res.json();
  return data.choices?.[0]?.message?.content?.trim() || "";
}

// ================== –û–°–ù–û–í–ù–û–ô –•–≠–ù–î–õ–ï–† NETLIFY ==================

exports.handler = async (event) => {
  console.log("=== telegram-asr-bot invoked ===");
  console.log("Method:", event.httpMethod);
  console.log("Headers:", event.headers);

  try {
    if (event.httpMethod === "OPTIONS") {
      return { statusCode: 200 };
    }

    if (event.httpMethod !== "POST") {
      return {
        statusCode: 405,
        body: "Method not allowed",
      };
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–∫—Ä–µ—Ç–∞ –≤–µ–±—Ö—É–∫–∞ (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å)
    if (WEBHOOK_SECRET) {
      const incoming = event.headers["x-telegram-bot-api-secret-token"];
      if (incoming !== WEBHOOK_SECRET) {
        console.warn("Bad webhook secret:", incoming);
        return { statusCode: 403, body: "Forbidden" };
      }
    }

    let update;
    try {
      update = JSON.parse(event.body || "{}");
    } catch (e) {
      console.error("Bad JSON from Telegram:", e);
      return { statusCode: 400, body: "Bad request" };
    }

    console.log("Update:", JSON.stringify(update));

    const msg = update.message || update.edited_message;
    if (!msg) {
      // –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ message (–Ω–∞–ø—Ä–∏–º–µ—Ä, callback_query –∏ —Ç.–ø.)
      return { statusCode: 200, body: "No message" };
    }

    const chatId = msg.chat?.id;
    const chatType = msg.chat?.type;
    const text = msg.text || msg.caption || "";

    // —Ä–∞–±–æ—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ –ª–∏—á–Ω—ã—Ö —á–∞—Ç–∞—Ö
    if (!chatId || chatType !== "private" || !text) {
      return { statusCode: 200, body: "Ignored" };
    }

    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
    addToSession(chatId, "user", text);

    // —Å–æ–±–∏—Ä–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è OpenAI
    const history = getSession(chatId);
    const messages = [
      { role: "system", content: SYSTEM_PROMPT },
      ...history,
    ];

    let assistantReply;
    try {
      assistantReply = await callOpenAI(messages);
    } catch (e) {
      console.error("OpenAI call failed:", e);
      await sendTelegramMessage(
        chatId,
        "–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –æ–ø–µ—Ä–∞—Ç–æ—Ä —Å–∫–æ—Ä–æ –æ—Ç–≤–µ—Ç–∏—Ç –≤—Ä—É—á–Ω—É—é."
      );
      return { statusCode: 200, body: "AI error" };
    }

    if (!assistantReply) {
      assistantReply =
        "–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –æ–ø–µ—Ä–∞—Ç–æ—Ä —Å–∫–æ—Ä–æ –æ—Ç–≤–µ—Ç–∏—Ç –≤—Ä—É—á–Ω—É—é.";
    }

    // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é
    addToSession(chatId, "assistant", assistantReply);

    // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—é
    await sendTelegramMessage(chatId, assistantReply);

    // ===== –õ–û–ì–ò–†–û–í–ê–ù–ò–ï –î–ò–ê–õ–û–ì–ê –í –ö–ê–ù–ê–õ =====
    if (LOG_CHAT_ID) {
      const username = msg.from?.username
        ? `@${msg.from.username}`
        : "";
      const fullName = `${msg.from?.first_name || ""} ${
        msg.from?.last_name || ""
      }`.trim();

      const logText =
        "üëÄ <b>–ù–æ–≤—ã–π –¥–∏–∞–ª–æ–≥ —Å –≤–æ–¥–∏—Ç–µ–ª–µ–º</b>\n\n" +
        `Chat ID: <code>${chatId}</code>\n` +
        (username ? `Username: ${escapeHtml(username)}\n` : "") +
        (fullName ? `–ò–º—è: ${escapeHtml(fullName)}\n` : "") +
        "\n<b>–°–æ–æ–±—â–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è:</b>\n" +
        `${escapeHtml(text)}\n\n` +
        "<b>–û—Ç–≤–µ—Ç –±–æ—Ç–∞:</b>\n" +
        `${escapeHtml(assistantReply)}`;

      await sendTelegramMessage(LOG_CHAT_ID, logText);
    }

    // –ø—Ä–æ—Å—Ç–∞—è –ª–æ–≥–∏–∫–∞ –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –µ—Å–ª–∏ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ–≤–æ—Ä–∏—Ç, —á—Ç–æ –ø–µ—Ä–µ–¥–∞—ë—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
    if (
      ADMIN_CHAT_ID &&
      /–ø–µ—Ä–µ–¥–∞—é –æ–ø–µ—Ä–∞—Ç–æ—Ä—É|–æ–ø–µ—Ä–∞—Ç–æ—Ä–≥–∞ —É–ª–∞–± –±–µ—Ä–∞–º–∞–Ω/i.test(assistantReply)
    ) {
      const username = msg.from?.username
        ? `@${msg.from.username}`
        : `${msg.from?.first_name || ""} ${msg.from?.last_name || ""}`.trim();

      const alertText =
        "‚ö†Ô∏è –ó–∞–ø—Ä–æ—Å –ø–µ—Ä–µ–¥–∞–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä—É.\n\n" +
        `–ß–∞—Ç: <code>${chatId}</code>\n` +
        (username ? `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${escapeHtml(username)}\n` : "") +
        `–ü–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤–æ–¥–∏—Ç–µ–ª—è:\n${escapeHtml(text)}`;

      await sendTelegramMessage(ADMIN_CHAT_ID, alertText);
    }

    return { statusCode: 200, body: "OK" };
  } catch (err) {
    console.error("telegram-asr-bot handler error:", err);
    return { statusCode: 500, body: "Internal error" };
  }
};
